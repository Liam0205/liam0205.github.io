<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/images/favicon/site.webmanifest">
  <meta name="msapplication-config" content="/images/favicon/browserconfig.xml">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="TYuJQFuiVqfbFfJAkHfXigSDRIMibztxXxgl_iAaQhA">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liam.page","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="这是一篇由 Liam Huang 翻译的译文，原文是 Brendan Gregg 所作的 gdb Debugging Full Example (Tutorial): ncurses。转载请保留本段文字，尊重作者和译者的权益。The author of this work is Brendan Gregg and this work was firstly posted on gdb Debug">
<meta name="keywords" content="GDB">
<meta property="og:type" content="article">
<meta property="og:title" content="GDB 入门教程：调试 ncurses 相关 bug 的完整范例">
<meta property="og:url" content="https://liam.page/2017/05/27/tutorial-to-GDB-taking-ncurses-as-an-example/index.html">
<meta property="og:site_name" content="始终">
<meta property="og:description" content="这是一篇由 Liam Huang 翻译的译文，原文是 Brendan Gregg 所作的 gdb Debugging Full Example (Tutorial): ncurses。转载请保留本段文字，尊重作者和译者的权益。The author of this work is Brendan Gregg and this work was firstly posted on gdb Debug">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-02-04T07:57:05.940Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GDB 入门教程：调试 ncurses 相关 bug 的完整范例">
<meta name="twitter:description" content="这是一篇由 Liam Huang 翻译的译文，原文是 Brendan Gregg 所作的 gdb Debugging Full Example (Tutorial): ncurses。转载请保留本段文字，尊重作者和译者的权益。The author of this work is Brendan Gregg and this work was firstly posted on gdb Debug">

<link rel="canonical" href="https://liam.page/2017/05/27/tutorial-to-GDB-taking-ncurses-as-an-example/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.css"><style>
#needsharebutton-postbottom {
  cursor: pointer;
  height: 26px;
  margin-top: 10px;
  position: relative;
}
#needsharebutton-postbottom .btn {
  border: 1px solid $btn-default-border-color;
  border-radius: 3px;
  display: initial;
  padding: 1px 4px;
}
</style>
  <title>GDB 入门教程：调试 ncurses 相关 bug 的完整范例 | 始终</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-44836433-1"></script>
    <script data-pjax>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-44836433-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">始终</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">不忘初心</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">346</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">12</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">669</span></a>

  </li>
        <li class="menu-item menu-item-系列">

    <a href="/series" rel="section"><i class="fa fa-fw fa-book"></i>系列</a>

  </li>
        <li class="menu-item menu-item-札记-&-留言板">

    <a href="/notes/" rel="section"><i class="fa fa-fw fa-sticky-note"></i>札记 & 留言板</a>

  </li>
        <li class="menu-item menu-item-英文">

    <a href="/en" rel="section"><i class="fa fa-fw fa-link"></i>英文</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liam.page/2017/05/27/tutorial-to-GDB-taking-ncurses-as-an-example/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar/avatar.webp">
      <meta itemprop="name" content="Liam Huang">
      <meta itemprop="description" content="虚室生白，吉祥止止">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="始终">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          GDB 入门教程：调试 ncurses 相关 bug 的完整范例
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017 年 05 月 27 日 23:24:40" itemprop="dateCreated datePublished" datetime="2017-05-27T23:24:40+08:00">2017 年 05 月 27 日</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020 年 02 月 04 日 15:57:05" itemprop="dateModified" datetime="2020-02-04T15:57:05+08:00">2020 年 02 月 04 日</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Skills/" itemprop="url" rel="index"><span itemprop="name">Computer Skills</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>60k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:48</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>这是一篇由 <a href="/">Liam Huang</a> 翻译的译文，原文是 <a href="http://www.brendangregg.com/blog/index.html" target="_blank" rel="noopener">Brendan Gregg</a> 所作的 <a href="http://www.brendangregg.com/blog/2016-08-09/gdb-example-ncurses.html" target="_blank" rel="noopener"><em>gdb Debugging Full Example (Tutorial): ncurses</em></a>。转载请保留本段文字，尊重作者和译者的权益。<br>The author of this work is <a href="http://www.brendangregg.com/blog/index.html" target="_blank" rel="noopener">Brendan Gregg</a> and this work was firstly posted on <a href="http://www.brendangregg.com/blog/2016-08-09/gdb-example-ncurses.html" target="_blank" rel="noopener"><em>gdb Debugging Full Example (Tutorial): ncurses</em></a>. This is the translation of the original work, by <a href="/">Liam Huang</a>. Please keep this information at the very top of your reprint, for the rights of the author and the translator.</p>
</blockquote>
<p>当我尝试在网上寻找「GDB 范例」时，我发现大多数文章只是贴出了命令，而没有讲解相关输出。GDB 是 GNU 调试器（GNU Debugger），亦是 Linux 系统上的标准调试器。在听 Greg Law 在 CppCon 2015 上关于 GDB 的演讲时（<a href="http://undo.io/resources/presentations/cppcon-2015-greg-law-give-me-15-minutes-ill-change/" target="_blank" rel="noopener">Give me 15 minutes and I&#39;ll change your view of GDB</a>），我发现 Law 给出了相关输出，从而意识到了上述不足。</p>
<p>Law 的演讲，也让我意识到应该分享一个使用 GDB 解决问题的完整范例：包括命令输出、各个步骤，以及一些死胡同。也就是说，这篇文章将分享使用 GDB 调试查错的一般步骤，而不是其他特别的东西。这篇文章介绍了 GDB 的基本使用方法，因此可以作为教程使用。不过，还有很多东西没有介绍，请谨记在心。</p>
<a id="more"></a>

<p>以下命令，均是以 <code>root</code> 权限执行的。这是因为，我调试的程序，目前需要以 <code>root</code> 权限执行。在实际使用中，并不是所有所需的命令都需要 <code>root</code> 权限。此外，本文罗列了解决问题的每一个步骤，你可以只浏览你感兴趣的部分。</p>
<h2 id="一-·-问题来了"><a href="#一-·-问题来了" class="headerlink" title="一 · 问题来了"></a>一 · 问题来了</h2><p><a href="https://github.com/iovisor/bcc" target="_blank" rel="noopener">bcc</a> 工具集是 BPF 工具箱的一部分。有人提起了一个 PR (Pull Request)，修改了其中的 <a href="https://github.com/iovisor/bcc/blob/master/tools/cachetop.py" target="_blank" rel="noopener">cachetop</a> 以使用 top-like display 显示 page cache 的统计。当我对这个 PR 进行测试时，程序提示段错误（segfault）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./cachetop.py</span></span><br><span class="line">Segmentation fault</span><br></pre></td></tr></table></figure>

<p>需要注意的是，Linux 提示程序遇到「段错误 <code>Segmentation fault</code>」，而不是「段错误（核心已转储）<code>Segmentation fault (Core Dumped)</code>」。而此处，我希望能通过核心转储文件，对错误进行调试。（核心转储文件是进程内存空间的拷贝，因此可以用于调试；这个术语源自早年的磁性核心记忆体）</p>
<p>分析核心转储文件，是调试查错的手段之一。不过，也有其他的调试办法。比如，在程序执行时，使用 GDB 检查问题；又或者使用外部工具，收集段错误发生时的数据和堆栈信息。不过，此处我们从核心转储文件的分析开始。</p>
<h2 id="二-·-获得核心转储文件"><a href="#二-·-获得核心转储文件" class="headerlink" title="二 · 获得核心转储文件"></a>二 · 获得核心转储文件</h2><p>首先，我需要检查一下关于核心转储的设置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ulimit -c</span></span><br><span class="line">0</span><br><span class="line"><span class="comment"># cat /proc/sys/kernel/core_pattern</span></span><br><span class="line">core</span><br></pre></td></tr></table></figure>

<p><code>ulimit -c</code> 是 Linux 的系统设置之一，用于限制生成核心转储文件的最大体积。此处，提示不允许转储进程内存。</p>
<p>另一方面，<code>/proc/sys/kernel/core_pattern</code> 的内容是 <code>core</code>。这意味着，发生核心转储时，Linux 会将进程内存空间转储到当前目录下名为 <code>core</code> 的文件当中。对于解决当前问题，这样的设置没什么问题。不过，我会希望将其存在某个固定的目录中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ulimit -c unlimited</span></span><br><span class="line"><span class="comment"># mkdir /var/cores</span></span><br><span class="line"><span class="comment"># echo "/var/cores/core.%e.%p" &gt; /proc/sys/kernel/core_pattern</span></span><br></pre></td></tr></table></figure>

<p>你也可以进一步调整 <code>core_pattern</code>。比如说，<code>%h</code> 表示机器名称，<code>%t</code> 表示转储发生的时间。这些 Linux 内核参数的文档在<a href="https://www.kernel.org/doc/Documentation/sysctl/kernel.txt" target="_blank" rel="noopener">这里</a>。</p>
<p>如果想要永久更改 <code>core_pattern</code> 的设置，你可以修改 <code>/etc/sysctl.conf</code> 文件中的 <code>kernel.core_pattern</code>。</p>
<p>如此，再试试看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./cachetop.py</span></span><br><span class="line">Segmentation fault (core dumped)</span><br><span class="line"><span class="comment"># ls -lh /var/cores</span></span><br><span class="line">total 19M</span><br><span class="line">-rw------- 1 root root 20M Aug  7 22:15 core.python.30520</span><br><span class="line"><span class="comment"># file /var/cores/core.python.30520</span></span><br><span class="line">/var/cores/core.python.30520: ELF 64-bit LSB core file x86-64, version 1 (SYSV), SVR4-style, from <span class="string">'python ./cachetop.py'</span></span><br><span class="line">That<span class="string">'s better: we have our core dump.</span></span><br></pre></td></tr></table></figure>

<p>这样一来，我们就有核心转储文件了。</p>
<h2 id="三-·-启动-GDB"><a href="#三-·-启动-GDB" class="headerlink" title="三 · 启动 GDB"></a>三 · 启动 GDB</h2><p>现在，我可以启动 GDB，调试目标程序和核心转储文件了。（这里使用了 <code>`which python`</code> 的方式获取系统中 <code>python</code> 的绝对路径）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb `which python` /var/cores/core.python.30520</span></span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-linux-gnu"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</span><br><span class="line">Reading symbols from /usr/bin/python...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">warning: core file may not match specified executable file.</span><br><span class="line">[New LWP 30520]</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.</span><br><span class="line"></span><br><span class="line">warning: JITed object file architecture unknown is not compatible with target architecture i386:x86-64.</span><br><span class="line">Core was generated by `python ./cachetop.py<span class="string">'.</span></span><br><span class="line"><span class="string">Program terminated with signal SIGSEGV, Segmentation fault.</span></span><br><span class="line"><span class="string">#0  0x00007f0a37aac40d in doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5</span></span><br></pre></td></tr></table></figure>

<p>最后两行包含有趣的信息：它告诉我们，段错误发生在 <code>libncursesw</code> 库的 <code>doupdate()</code> 函数中。这类问题，可以考虑在网上检索，看看是否是已知问题。当然，我遇到的这个问题，没有其他人报告过。</p>
<p>对我来说，我大概能猜到 <code>libncursesw</code> 是做什么的。不过，如果对你来说这很陌生的话，首先你应该知道 <code>/lib</code> 开头并以 <code>*.so</code> 结尾说明它是一个共享对象（动态库）。接下来，你可以尝试通过 <code>man</code> 命令、网页、软件包说明等方式，弄清楚它是做什么的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dpkg -l | grep libncursesw</span></span><br><span class="line">ii  libncursesw5:amd64                  6.0+20160213-1ubuntu1                    amd64</span><br><span class="line">     shared libraries <span class="keyword">for</span> terminal handling (wide character support)</span><br></pre></td></tr></table></figure>

<p>我这里是在 Ubuntu 上调试，不过，在其他 Linux 发行上调试也基本没差。</p>
<h2 id="四-·-逆向追溯"><a href="#四-·-逆向追溯" class="headerlink" title="四 · 逆向追溯"></a>四 · 逆向追溯</h2><p>逆向追溯调用栈，能让我们知道程序是如何一步步调用直到出现问题的。对于一般的问题，逆向追溯调用栈，就足够定位出问题了。因此，我在 GDB 中都会首先尝试使用这一命令：<code>bt</code>（<code>backtrace</code> 的缩写）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  0x00007f0a37aac40d in doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5</span></span><br><span class="line"><span class="comment">#1  0x00007f0a37aa07e6 in wrefresh () from /lib/x86_64-linux-gnu/libncursesw.so.5</span></span><br><span class="line"><span class="comment">#2  0x00007f0a37a99616 in ?? () from /lib/x86_64-linux-gnu/libncursesw.so.5</span></span><br><span class="line"><span class="comment">#3  0x00007f0a37a9a325 in wgetch () from /lib/x86_64-linux-gnu/libncursesw.so.5</span></span><br><span class="line"><span class="comment">#4  0x00007f0a37cc6ec3 in ?? () from /usr/lib/python2.7/lib-dynload/_curses.x86_64-linux-gnu.so</span></span><br><span class="line"><span class="comment">#5  0x00000000004c4d5a in PyEval_EvalFrameEx ()</span></span><br><span class="line"><span class="comment">#6  0x00000000004c2e05 in PyEval_EvalCodeEx ()</span></span><br><span class="line"><span class="comment">#7  0x00000000004def08 in ?? ()</span></span><br><span class="line"><span class="comment">#8  0x00000000004b1153 in PyObject_Call ()</span></span><br><span class="line"><span class="comment">#9  0x00000000004c73ec in PyEval_EvalFrameEx ()</span></span><br><span class="line"><span class="comment">#10 0x00000000004c2e05 in PyEval_EvalCodeEx ()</span></span><br><span class="line"><span class="comment">#11 0x00000000004caf42 in PyEval_EvalFrameEx ()</span></span><br><span class="line"><span class="comment">#12 0x00000000004c2e05 in PyEval_EvalCodeEx ()</span></span><br><span class="line"><span class="comment">#13 0x00000000004c2ba9 in PyEval_EvalCode ()</span></span><br><span class="line"><span class="comment">#14 0x00000000004f20ef in ?? ()</span></span><br><span class="line"><span class="comment">#15 0x00000000004eca72 in PyRun_FileExFlags ()</span></span><br><span class="line"><span class="comment">#16 0x00000000004eb1f1 in PyRun_SimpleFileExFlags ()</span></span><br><span class="line"><span class="comment">#17 0x000000000049e18a in Py_Main ()</span></span><br><span class="line"><span class="comment">#18 0x00007f0a3be10830 in __libc_start_main (main=0x49daf0 &lt;main&gt;, argc=2, argv=0x7ffd33d94838, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;,</span></span><br><span class="line">    stack_end=0x7ffd33d94828) at ../csu/libc-start.c:291</span><br><span class="line"><span class="comment">#19 0x000000000049da19 in _start ()</span></span><br></pre></td></tr></table></figure>

<p>这里，自底向上的方向即是调用者 <code>-&gt;</code> 被调用的方向。其中 <code>??</code> 表示符号转义失败。遍历调用栈生成栈回溯记录的过程也有可能失败。这种情况下，你可能会看到一个地址值很小的栈帧，当然，这个地址通常是错误的。如果这些问题很严重，那么就要考虑修复这些问题：安装相应软件包的调试信息包（为 GDB 提供更多符号，且允许 GDB 做基于 DWARF 的遍历），或是在编译程序时禁止编译器优化栈帧指针并包含调试信息（<code>-fno-omit-frame-pointer -g</code>）。这里的 <code>??</code> 在安装 <code>python-dbg</code> 软件包之后，大都都能解决。</p>
<p>仅从调用栈来看，信息似乎不太够：<code>#5</code> 至 <code>#17</code> 是在 Python 内部，而后经由 <code>_curses</code> 库调用进入 <code>libncursesw</code>。在 <code>libncursesw</code> 中，<code>wgetch()-&gt;wrefresh()-&gt;doupdate()</code> 调用顺序看起来进行了一次窗口刷新。但是，为什么这会引发核心转储呢？</p>
<h2 id="五-·-反汇编"><a href="#五-·-反汇编" class="headerlink" title="五 · 反汇编"></a>五 · 反汇编</h2><p>接下来，我要反汇编导致段错误的函数 <code>doupdate()</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disas doupdate</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> doupdate:</span><br><span class="line">   0x00007f0a37aac2e0 &lt;+0&gt;:   push   %r15</span><br><span class="line">   0x00007f0a37aac2e2 &lt;+2&gt;:   push   %r14</span><br><span class="line">   0x00007f0a37aac2e4 &lt;+4&gt;:   push   %r13</span><br><span class="line">   0x00007f0a37aac2e6 &lt;+6&gt;:   push   %r12</span><br><span class="line">   0x00007f0a37aac2e8 &lt;+8&gt;:   push   %rbp</span><br><span class="line">   0x00007f0a37aac2e9 &lt;+9&gt;:   push   %rbx</span><br><span class="line">   0x00007f0a37aac2ea &lt;+10&gt;:  sub    <span class="variable">$0xc8</span>,%rsp</span><br><span class="line">[...]</span><br><span class="line">---Type &lt;<span class="built_in">return</span>&gt; to <span class="built_in">continue</span>, or q &lt;<span class="built_in">return</span>&gt; to quit---</span><br><span class="line">[...]</span><br><span class="line">   0x00007f0a37aac3f7 &lt;+279&gt;: cmpb   <span class="variable">$0x0</span>,0x21(%rcx)</span><br><span class="line">   0x00007f0a37aac3fb &lt;+283&gt;: je     0x7f0a37aacc3b &lt;doupdate+2395&gt;</span><br><span class="line">   0x00007f0a37aac401 &lt;+289&gt;: mov    0x20cb68(%rip),%rax        <span class="comment"># 0x7f0a37cb8f70</span></span><br><span class="line">   0x00007f0a37aac408 &lt;+296&gt;: mov    (%rax),%rsi</span><br><span class="line">   0x00007f0a37aac40b &lt;+299&gt;: xor    %eax,%eax</span><br><span class="line">=&gt; 0x00007f0a37aac40d &lt;+301&gt;: mov    0x10(%rsi),%rdi</span><br><span class="line">   0x00007f0a37aac411 &lt;+305&gt;: cmpb   <span class="variable">$0x0</span>,0x1c(%rdi)</span><br><span class="line">   0x00007f0a37aac415 &lt;+309&gt;: jne    0x7f0a37aac6f7 &lt;doupdate+1047&gt;</span><br><span class="line">   0x00007f0a37aac41b &lt;+315&gt;: movswl 0x4(%rcx),%ecx</span><br><span class="line">   0x00007f0a37aac41f &lt;+319&gt;: movswl 0x74(%rdx),%edi</span><br><span class="line">   0x00007f0a37aac423 &lt;+323&gt;: mov    %rax,0x40(%rsp)</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>这里的输出做了适当的截断。（我也可以直接输入 <code>disas</code>，以查看当前函数的汇编代码）</p>
<p><code>=&gt;</code> 箭头标注的位置，即是产生段错误的指令地址。该指令中（<code>mov    0x10(%rsi),%rdi</code>），<code>%rsi</code> 寄存器保存了一个内存地址，之前的 <code>0x10</code> 表示在这个内存地址的基础上做 <code>0x10</code> 的偏移；<code>%rdi</code> 则是另一个寄存器。该指令的作用，是将上述偏移过的内存地址中保存的内容，拷贝到 <code>%rdi</code> 寄存器当中。接下来，我们要看看寄存器的状态。</p>
<h2 id="六-·-查看寄存器状态"><a href="#六-·-查看寄存器状态" class="headerlink" title="六 · 查看寄存器状态"></a>六 · 查看寄存器状态</h2><p>使用命令 <code>i r</code>（<code>info registers</code> 的缩写）可以打印寄存器状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(gdb) i r</span><br><span class="line">rax            0x0  0</span><br><span class="line">rbx            0x1993060    26816608</span><br><span class="line">rcx            0x19902a0    26804896</span><br><span class="line">rdx            0x19ce7d0    27060176</span><br><span class="line">rsi            0x0  0</span><br><span class="line">rdi            0x19ce7d0    27060176</span><br><span class="line">rbp            0x7f0a3848eb10   0x7f0a3848eb10 &lt;SP&gt;</span><br><span class="line">rsp            0x7ffd33d93c00   0x7ffd33d93c00</span><br><span class="line">r8             0x7f0a37cb93e0   139681862489056</span><br><span class="line">r9             0x0  0</span><br><span class="line">r10            0x8  8</span><br><span class="line">r11            0x202    514</span><br><span class="line">r12            0x0  0</span><br><span class="line">r13            0x0  0</span><br><span class="line">r14            0x7f0a3848eb10   139681870703376</span><br><span class="line">r15            0x19ce7d0    27060176</span><br><span class="line">rip            0x7f0a37aac40d   0x7f0a37aac40d &lt;doupdate+301&gt;</span><br><span class="line">eflags         0x10246  [ PF ZF IF RF ]</span><br><span class="line">cs             0x33 51</span><br><span class="line">ss             0x2b 43</span><br><span class="line">ds             0x0  0</span><br><span class="line">es             0x0  0</span><br><span class="line">fs             0x0  0</span><br><span class="line">gs             0x0  0</span><br></pre></td></tr></table></figure>

<p>好吧，<code>%rsi</code> 这个寄存器中，保存的是一个空指针（<code>0x0</code>）。这就怪不得要出问题了。解引用一个未初始化的指针，或是解引用空指针，是段错误的常见原因。</p>
<h2 id="七-·-内存映射"><a href="#七-·-内存映射" class="headerlink" title="七 · 内存映射"></a>七 · 内存映射</h2><p>你可以再确认一下此时 <code>0x0</code> 是否是有效的地址。在 GDB 中使用 <code>i proc m</code>（<code>info proc mappings</code> 的缩写）可以查看内存映射状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(gdb) i proc m</span><br><span class="line">Mapped address spaces:</span><br><span class="line"></span><br><span class="line">      Start Addr           End Addr       Size     Offset objfile</span><br><span class="line">        0x400000           0x6e7000   0x2e7000        0x0 /usr/bin/python2.7</span><br><span class="line">        0x8e6000           0x8e8000     0x2000   0x2e6000 /usr/bin/python2.7</span><br><span class="line">        0x8e8000           0x95f000    0x77000   0x2e8000 /usr/bin/python2.7</span><br><span class="line">  0x7f0a37a8b000     0x7f0a37ab8000    0x2d000        0x0 /lib/x86_64-linux-gnu/libncursesw.so.5.9</span><br><span class="line">  0x7f0a37ab8000     0x7f0a37cb8000   0x200000    0x2d000 /lib/x86_64-linux-gnu/libncursesw.so.5.9</span><br><span class="line">  0x7f0a37cb8000     0x7f0a37cb9000     0x1000    0x2d000 /lib/x86_64-linux-gnu/libncursesw.so.5.9</span><br><span class="line">  0x7f0a37cb9000     0x7f0a37cba000     0x1000    0x2e000 /lib/x86_64-linux-gnu/libncursesw.so.5.9</span><br><span class="line">  0x7f0a37cba000     0x7f0a37ccd000    0x13000        0x0 /usr/lib/python2.7/lib-dynload/_curses.x86_64-linux-gnu.so</span><br><span class="line">  0x7f0a37ccd000     0x7f0a37ecc000   0x1ff000    0x13000 /usr/lib/python2.7/lib-dynload/_curses.x86_64-linux-gnu.so</span><br><span class="line">  0x7f0a37ecc000     0x7f0a37ecd000     0x1000    0x12000 /usr/lib/python2.7/lib-dynload/_curses.x86_64-linux-gnu.so</span><br><span class="line">  0x7f0a37ecd000     0x7f0a37ecf000     0x2000    0x13000 /usr/lib/python2.7/lib-dynload/_curses.x86_64-linux-gnu.so</span><br><span class="line">  0x7f0a38050000     0x7f0a38066000    0x16000        0x0 /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">  0x7f0a38066000     0x7f0a38265000   0x1ff000    0x16000 /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">  0x7f0a38265000     0x7f0a38266000     0x1000    0x15000 /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">  0x7f0a38266000     0x7f0a3828b000    0x25000        0x0 /lib/x86_64-linux-gnu/libtinfo.so.5.9</span><br><span class="line">  0x7f0a3828b000     0x7f0a3848a000   0x1ff000    0x25000 /lib/x86_64-linux-gnu/libtinfo.so.5.9</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>如此可以看到，虚存空间有效地址的最低位是 <code>0x400000</code>。因此，显而易见 <code>0x0</code> 此时是一个非法的地址，所以使用它会导致段错误。</p>
<p>至此为止，继续深入进行调试的方法有多重。我将从指令的角度继续深入。</p>
<h2 id="八-·-断点"><a href="#八-·-断点" class="headerlink" title="八 · 断点"></a>八 · 断点</h2><p>回到刚才的反汇编的结果。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   0x00007f0a37aac401 &lt;+289&gt;:   mov    0x20cb68(%rip),%rax        <span class="comment"># 0x7f0a37cb8f70</span></span><br><span class="line">   0x00007f0a37aac408 &lt;+296&gt;:   mov    (%rax),%rsi</span><br><span class="line">   0x00007f0a37aac40b &lt;+299&gt;:   xor    %eax,%eax</span><br><span class="line">=&gt; 0x00007f0a37aac40d &lt;+301&gt;:   mov    0x10(%rsi),%rdi</span><br></pre></td></tr></table></figure>

<p>从汇编指令来看，代码似乎首先从栈上将某个信息拷贝到 <code>%rax</code> 寄存器当中。而后解引用 <code>%rax</code> 寄存器里的内容，并拷贝到 <code>%rsi</code> 寄存器。而后通过 <code>xor</code> 将 <code>%eax</code> 寄存器中的内容置零。最后执行到产生段错误的代码。在这里，<code>%eax</code> 有可能提供更多的信息。（译注：原作者写的是 <code>%rax</code>，这应该是手误）但是在段错误之前，它已经被置零了，因此我们看不到更多的信息。</p>
<p>我可以将断点设置在 <code>doupdate+298</code> 处，而后顺着指令单步调试，看看各个寄存器的值是如何变化的。为此，首先我得启动 GDB，以便在其中实时执行程序。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb `which python`</span></span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86\_64-linux-gnu"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</span><br><span class="line">Reading symbols from /usr/bin/python...(no debugging symbols found)...<span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>

<p>而后，使用 <code>b</code> 命令（<code>break</code> 的缩写）设置断点。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b *doupdate + 289</span><br><span class="line">No symbol table is loaded.  Use the <span class="string">"file"</span> <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure>

<p>啊，出错了……这是我有意呈现的错误。通常，我们会将断点首先设置在 <code>main</code> 处，因为彼时符号应该都加载完毕了。而后，在程序遇到断点并暂停时，我们可以设置其他断点。此处，我需要关注 <code>doupdate</code> 函数，因此，我将断点首先设置在这个函数被调用的地方。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b doupdate</span><br><span class="line">Function <span class="string">"doupdate"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 1 (doupdate) pending.</span><br><span class="line">(gdb) r cachetop.py</span><br><span class="line">Starting program: /usr/bin/python cachetop.py</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.</span><br><span class="line">warning: JITed object file architecture unknown is not compatible with target architecture i386:x86-64.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x00007ffff34ad2e0 <span class="keyword">in</span> doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5</span><br><span class="line">(gdb) b *doupdate + 289</span><br><span class="line">Breakpoint 2 at 0x7ffff34ad401</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 2, 0x00007ffff34ad401 <span class="keyword">in</span> doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5</span><br></pre></td></tr></table></figure>

<p>如此，我们就来到了目标断点位置。</p>
<p>这里，<code>r</code> (<code>run</code>) 命令将参数传给被 GDB 跟踪的程序（这里是 <code>python</code>），以便执行目标 Python 脚本。因此，这里相当于执行了 <code>python cachetop.py</code>。</p>
<h2 id="⑨-·-单步调试"><a href="#⑨-·-单步调试" class="headerlink" title="⑨ · 单步调试"></a>⑨ · 单步调试</h2><p>至此，我使用 <code>si</code> (<code>stepi</code>) 命令，让程序单步地向前执行一条指令，而后检查寄存器状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(gdb) si</span><br><span class="line">0x00007ffff34ad408 <span class="keyword">in</span> doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5</span><br><span class="line">(gdb) i r</span><br><span class="line">rax            0x7ffff3e8f948   140737285519688</span><br><span class="line">rbx            0xaea060 11444320</span><br><span class="line">rcx            0xae72a0 11432608</span><br><span class="line">rdx            0xa403d0 10748880</span><br><span class="line">rsi            0x7ffff7ea8e10   140737352732176</span><br><span class="line">rdi            0xa403d0 10748880</span><br><span class="line">rbp            0x7ffff3e8fb10   0x7ffff3e8fb10 &lt;SP&gt;</span><br><span class="line">rsp            0x7fffffffd390   0x7fffffffd390</span><br><span class="line">r8             0x7ffff36ba3e0   140737277305824</span><br><span class="line">r9             0x0  0</span><br><span class="line">r10            0x8  8</span><br><span class="line">r11            0x202    514</span><br><span class="line">r12            0x0  0</span><br><span class="line">r13            0x0  0</span><br><span class="line">r14            0x7ffff3e8fb10   140737285520144</span><br><span class="line">r15            0xa403d0 10748880</span><br><span class="line">rip            0x7ffff34ad408   0x7ffff34ad408 &lt;doupdate+296&gt;</span><br><span class="line">eflags         0x202    [ IF ]</span><br><span class="line">cs             0x33 51</span><br><span class="line">ss             0x2b 43</span><br><span class="line">ds             0x0  0</span><br><span class="line">es             0x0  0</span><br><span class="line">fs             0x0  0</span><br><span class="line">gs             0x0  0</span><br><span class="line">(gdb) p/a 0x7ffff3e8f948</span><br><span class="line"><span class="variable">$1</span> = 0x7ffff3e8f948 &lt;cur_term&gt;</span><br></pre></td></tr></table></figure>

<p>新的线索出现了。看起来，我们对空指针解引用的操作，发生在一个名为 <code>cur_term</code> 的符号当中。（<code>p/a</code> 是 <code>print/a</code> 的缩写，其中 <code>/a</code> 表示随后传入的是一个内存地址）考虑到这是在调试 ncurses，那么，是不是我们的 <code>TERM</code> 环境设置有问题呢？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo $TERM</span></span><br><span class="line">xterm-256color</span><br></pre></td></tr></table></figure>

<p>我尝试将其设为 <code>vt100</code>，但是执行程序依旧得到了相同的段错误。</p>
<p>注意，此处我检查的是 <code>doupdate</code> 函数第一次被调用的情形，但实际上它可能被多次调用，而且问题可能出在后续的调用中。为此，我们可以让程序持续执行（<code>c</code> 命令），直到撞见我们期待的那次调用。然而，调用次数少的话，可能还好。若是调用多次，这就不好办了。（第 15 节将讨论这个问题）</p>
<h2 id="十-·-单步回退"><a href="#十-·-单步回退" class="headerlink" title="十 · 单步回退"></a>十 · 单步回退</h2><p>单步回退是 GDB 的重要特性之一，Law 在它的演讲中也有提到。我们看一个例子。</p>
<p>我会重启整个 GDB 会话，从头开始演示。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb `which python`</span></span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86\_64-linux-gnu"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</span><br><span class="line">Reading symbols from /usr/bin/python...(no debugging symbols found)...<span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>

<p>而后，我将断点设置在 <code>doupdate</code> 函数上；当遇到之后，我会打开记录功能，直到进程崩溃。这种记录功能，对系统影响是很大的。所以，最好不要从 <code>main</code> 函数就开始记录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b doupdate</span><br><span class="line">Function <span class="string">"doupdate"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 1 (doupdate) pending.</span><br><span class="line">(gdb) r cachetop.py</span><br><span class="line">Starting program: /usr/bin/python cachetop.py</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.</span><br><span class="line">warning: JITed object file architecture unknown is not compatible with target architecture i386:x86-64.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x00007ffff34ad2e0 <span class="keyword">in</span> doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5</span><br><span class="line">(gdb) record</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x00007ffff34ad40d <span class="keyword">in</span> doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5</span><br></pre></td></tr></table></figure>

<p>至此，我就可以在代码行或者指令的意义上单步回退了。单步回退的原理，是从记录中，回放寄存器的状态。此处，我回退两个指令，而后打印寄存器状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">(gdb) reverse-stepi</span><br><span class="line">0x00007ffff34ad40d <span class="keyword">in</span> doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5</span><br><span class="line">(gdb) reverse-stepi</span><br><span class="line">0x00007ffff34ad40b <span class="keyword">in</span> doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5</span><br><span class="line">(gdb) i r</span><br><span class="line">rax            0x7ffff3e8f948   140737285519688</span><br><span class="line">rbx            0xaea060 11444320</span><br><span class="line">rcx            0xae72a0 11432608</span><br><span class="line">rdx            0xa403d0 10748880</span><br><span class="line">rsi            0x0  0</span><br><span class="line">rdi            0xa403d0 10748880</span><br><span class="line">rbp            0x7ffff3e8fb10   0x7ffff3e8fb10 &lt;SP&gt;</span><br><span class="line">rsp            0x7fffffffd390   0x7fffffffd390</span><br><span class="line">r8             0x7ffff36ba3e0   140737277305824</span><br><span class="line">r9             0x0  0</span><br><span class="line">r10            0x8  8</span><br><span class="line">r11            0x302    770</span><br><span class="line">r12            0x0  0</span><br><span class="line">r13            0x0  0</span><br><span class="line">r14            0x7ffff3e8fb10   140737285520144</span><br><span class="line">r15            0xa403d0 10748880</span><br><span class="line">rip            0x7ffff34ad40b   0x7ffff34ad40b &lt;doupdate+299&gt;</span><br><span class="line">eflags         0x202    [ IF ]</span><br><span class="line">cs             0x33 51</span><br><span class="line">ss             0x2b 43</span><br><span class="line">ds             0x0  0</span><br><span class="line">es             0x0  0</span><br><span class="line">fs             0x0  0</span><br><span class="line">gs             0x0  0</span><br><span class="line">(gdb) p/a 0x7ffff3e8f948</span><br><span class="line"><span class="variable">$1</span> = 0x7ffff3e8f948 &lt;cur_term&gt;</span><br></pre></td></tr></table></figure>

<p>这次确定无疑，我们又一次定位到了 <code>cur_term</code> 这条线索。此时，我很想读读源码，但是首先我会试着看到更多的调试信息。</p>
<h2 id="十一-·-调试信息"><a href="#十一-·-调试信息" class="headerlink" title="十一 · 调试信息"></a>十一 · 调试信息</h2><p>这里，我们需要（在 Ubuntu 上）安装 <code>libncursesw</code> 的调试信息包。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apt-cache search libncursesw</span></span><br><span class="line">libncursesw5 - shared libraries <span class="keyword">for</span> terminal handling (wide character support)</span><br><span class="line">libncursesw5-dbg - debugging/profiling libraries <span class="keyword">for</span> ncursesw</span><br><span class="line">libncursesw5-dev - developer<span class="string">'s libraries for ncursesw</span></span><br><span class="line"><span class="string"># dpkg -l | grep libncursesw</span></span><br><span class="line"><span class="string">ii  libncursesw5:amd64                  6.0+20160213-1ubuntu1                    amd64        shared libraries for terminal handling (wide character support)</span></span><br><span class="line"><span class="string"># apt-get install -y libncursesw5-dbg</span></span><br><span class="line"><span class="string">Reading package lists... Done</span></span><br><span class="line"><span class="string">Building dependency tree</span></span><br><span class="line"><span class="string">Reading state information... Done</span></span><br><span class="line"><span class="string">[...]</span></span><br><span class="line"><span class="string">After this operation, 2,488 kB of additional disk space will be used.</span></span><br><span class="line"><span class="string">Get:1 http://us-west-1.ec2.archive.ubuntu.com/ubuntu xenial/main amd64 libncursesw5-dbg amd64 6.0+20160213-1ubuntu1 [729 kB]</span></span><br><span class="line"><span class="string">Fetched 729 kB in 0s (865 kB/s)</span></span><br><span class="line"><span class="string">Selecting previously unselected package libncursesw5-dbg.</span></span><br><span class="line"><span class="string">(Reading database ... 200094 files and directories currently installed.)</span></span><br><span class="line"><span class="string">Preparing to unpack .../libncursesw5-dbg_6.0+20160213-1ubuntu1_amd64.deb ...</span></span><br><span class="line"><span class="string">Unpacking libncursesw5-dbg (6.0+20160213-1ubuntu1) ...</span></span><br><span class="line"><span class="string">Setting up libncursesw5-dbg (6.0+20160213-1ubuntu1) ...</span></span><br><span class="line"><span class="string"># dpkg -l | grep libncursesw</span></span><br><span class="line"><span class="string">ii  libncursesw5:amd64                  6.0+20160213-1ubuntu1                    amd64        shared libraries for terminal handling (wide character support)</span></span><br><span class="line"><span class="string">ii  libncursesw5-dbg                    6.0+20160213-1ubuntu1                    amd64        debugging/profiling libraries for ncursesw</span></span><br></pre></td></tr></table></figure>

<p>赞~！此处的调试信息包与动态库的版本是一致的。现在的段错误看起来是怎样的呢？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb `which python` /var/cores/core.python.30520</span></span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1</span><br><span class="line">[...]</span><br><span class="line">warning: JITed object file architecture unknown is not compatible with target architecture i386:x86-64.</span><br><span class="line">Core was generated by `python ./cachetop.py<span class="string">'.</span></span><br><span class="line"><span class="string">Program terminated with signal SIGSEGV, Segmentation fault.</span></span><br><span class="line"><span class="string">#0  ClrBlank (win=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1129</span></span><br><span class="line"><span class="string">1129        if (back_color_erase)</span></span><br><span class="line"><span class="string">(gdb) bt</span></span><br><span class="line"><span class="string">#0  ClrBlank (win=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1129</span></span><br><span class="line"><span class="string">#1  ClrUpdate () at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1147</span></span><br><span class="line"><span class="string">#2  doupdate () at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1010</span></span><br><span class="line"><span class="string">#3  0x00007f0a37aa07e6 in wrefresh (win=win@entry=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_refresh.c:65</span></span><br><span class="line"><span class="string">#4  0x00007f0a37a99499 in recur_wrefresh (win=win@entry=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_getch.c:384</span></span><br><span class="line"><span class="string">#5  0x00007f0a37a99616 in _nc_wgetch (win=win@entry=0x1993060, result=result@entry=0x7ffd33d93e24, use_meta=1)</span></span><br><span class="line"><span class="string">    at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_getch.c:491</span></span><br><span class="line"><span class="string">#6  0x00007f0a37a9a325 in wgetch (win=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_getch.c:672</span></span><br><span class="line"><span class="string">#7  0x00007f0a37cc6ec3 in ?? () from /usr/lib/python2.7/lib-dynload/_curses.x86_64-linux-gnu.so</span></span><br><span class="line"><span class="string">#8  0x00000000004c4d5a in PyEval_EvalFrameEx ()</span></span><br><span class="line"><span class="string">#9  0x00000000004c2e05 in PyEval_EvalCodeEx ()</span></span><br><span class="line"><span class="string">#10 0x00000000004def08 in ?? ()</span></span><br><span class="line"><span class="string">#11 0x00000000004b1153 in PyObject_Call ()</span></span><br><span class="line"><span class="string">#12 0x00000000004c73ec in PyEval_EvalFrameEx ()</span></span><br><span class="line"><span class="string">#13 0x00000000004c2e05 in PyEval_EvalCodeEx ()</span></span><br><span class="line"><span class="string">#14 0x00000000004caf42 in PyEval_EvalFrameEx ()</span></span><br><span class="line"><span class="string">#15 0x00000000004c2e05 in PyEval_EvalCodeEx ()</span></span><br><span class="line"><span class="string">#16 0x00000000004c2ba9 in PyEval_EvalCode ()</span></span><br><span class="line"><span class="string">#17 0x00000000004f20ef in ?? ()</span></span><br><span class="line"><span class="string">#18 0x00000000004eca72 in PyRun_FileExFlags ()</span></span><br><span class="line"><span class="string">#19 0x00000000004eb1f1 in PyRun_SimpleFileExFlags ()</span></span><br><span class="line"><span class="string">#20 0x000000000049e18a in Py_Main ()</span></span><br><span class="line"><span class="string">#21 0x00007f0a3be10830 in __libc_start_main (main=0x49daf0 &lt;main&gt;, argc=2, argv=0x7ffd33d94838, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;,</span></span><br><span class="line"><span class="string">    stack_end=0x7ffd33d94828) at ../csu/libc-start.c:291</span></span><br><span class="line"><span class="string">#22 0x000000000049da19 in _start ()</span></span><br></pre></td></tr></table></figure>

<p>调用栈看起来稍微有些不一样了。发生段错误的地方，实际是在 <code>ClrBlank()</code> 函数当中。它首先被内联到 <code>ClrUpdate()</code> 当中，最后内联到 <code>doupdate()</code> 当中。</p>
<p>至此，我真的要读读代码了。</p>
<h2 id="十二-·-源代码"><a href="#十二-·-源代码" class="headerlink" title="十二 · 源代码"></a>十二 · 源代码</h2><p>有了调试信息包，GDB 可以将源代码和汇编码打印在一起。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disas/s</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> doupdate:</span><br><span class="line">/build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:</span><br><span class="line">759 &#123;</span><br><span class="line">   0x00007f0a37aac2e0 &lt;+0&gt;:   push   %r15</span><br><span class="line">   0x00007f0a37aac2e2 &lt;+2&gt;:   push   %r14</span><br><span class="line">   0x00007f0a37aac2e4 &lt;+4&gt;:   push   %r13</span><br><span class="line">   0x00007f0a37aac2e6 &lt;+6&gt;:   push   %r12</span><br><span class="line">[...]</span><br><span class="line">   0x00007f0a37aac3dd &lt;+253&gt;: jne    0x7f0a37aac6ca &lt;doupdate+1002&gt;</span><br><span class="line"></span><br><span class="line">1009        <span class="keyword">if</span> (CurScreen(SP_PARM)-&gt;_clear || NewScreen(SP_PARM)-&gt;_clear) &#123;   /* force refresh ? */</span><br><span class="line">   0x00007f0a37aac3e3 &lt;+259&gt;: mov    0x80(%rdx),%rax</span><br><span class="line">   0x00007f0a37aac3ea &lt;+266&gt;: mov    0x88(%rdx),%rcx</span><br><span class="line">   0x00007f0a37aac3f1 &lt;+273&gt;: cmpb   <span class="variable">$0x0</span>,0x21(%rax)</span><br><span class="line">   0x00007f0a37aac3f5 &lt;+277&gt;: jne    0x7f0a37aac401 &lt;doupdate+289&gt;</span><br><span class="line">   0x00007f0a37aac3f7 &lt;+279&gt;: cmpb   <span class="variable">$0x0</span>,0x21(%rcx)</span><br><span class="line">   0x00007f0a37aac3fb &lt;+283&gt;: je     0x7f0a37aacc3b &lt;doupdate+2395&gt;</span><br><span class="line"></span><br><span class="line">1129        <span class="keyword">if</span> (back_color_erase)</span><br><span class="line">   0x00007f0a37aac401 &lt;+289&gt;: mov    0x20cb68(%rip),%rax        <span class="comment"># 0x7f0a37cb8f70</span></span><br><span class="line">   0x00007f0a37aac408 &lt;+296&gt;: mov    (%rax),%rsi</span><br><span class="line"></span><br><span class="line">1128        NCURSES_CH_T blank = blankchar;</span><br><span class="line">   0x00007f0a37aac40b &lt;+299&gt;: xor    %eax,%eax</span><br><span class="line"></span><br><span class="line">1129        <span class="keyword">if</span> (back_color_erase)</span><br><span class="line">=&gt; 0x00007f0a37aac40d &lt;+301&gt;: mov    0x10(%rsi),%rdi</span><br><span class="line">   0x00007f0a37aac411 &lt;+305&gt;: cmpb   <span class="variable">$0x0</span>,0x1c(%rdi)</span><br><span class="line">   0x00007f0a37aac415 &lt;+309&gt;: jne    0x7f0a37aac6f7 &lt;doupdate+1047&gt;</span><br></pre></td></tr></table></figure>

<p>好，依旧有 <code>=&gt;</code> 作为出问题指令的标记，以及指令对应的代码打印在其上。那么，程序产生段错误，是因为 <code>if(back_color_erase)</code> 这一行代码吗？看起来似乎不太可能。段错误产生的原因是对指向非法地址的指针进行解引用，例如 <code>a-&gt;b</code> 或者 <code>*a</code>。但在此处，<code>back_color_erase</code> 仅只是普通地访问变量，没有解引用的动作，是不会引起段错误的。</p>
<p>为此，我反复检查了调试信息包的版本是否匹配，而后重新在 GDB 里执行程序，但无有收获——段错误发生在同一位置。</p>
<p>那么，是不是 <code>back_color_erase</code> 本身有什么特别之处呢？现在我们在 <code>ClrBlank</code> 函数中，我试着列出它的源代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) list ClrBlank</span><br><span class="line">1124</span><br><span class="line">1125    static NCURSES_INLINE NCURSES_CH_T</span><br><span class="line">1126    ClrBlank(NCURSES_SP_DCLx WINDOW *win)</span><br><span class="line">1127    &#123;</span><br><span class="line">1128        NCURSES_CH_T blank = blankchar;</span><br><span class="line">1129        <span class="keyword">if</span> (back_color_erase)</span><br><span class="line">1130        AddAttr(blank, (AttrOf(BCE_BKGD(SP_PARM, win)) &amp; BCE_ATTRS));</span><br><span class="line">1131        <span class="built_in">return</span> blank;</span><br><span class="line">1132    &#125;</span><br><span class="line">1133</span><br></pre></td></tr></table></figure>

<p>呃……<code>back_color_erase</code> 在函数里是未定义的，看起来是一个全局变量？</p>
<h2 id="十三-·-TUI"><a href="#十三-·-TUI" class="headerlink" title="十三 · TUI"></a>十三 · TUI</h2><p>TUI 是 text user interface（文本用户界面）的缩写。这一界面我甚少使用，我也是听过 Law 的讲座之后受到的启发。</p>
<p>为此，你需要在 GDB 启动的时候，传入 <code>--tui</code> 参数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb --tui `which python` /var/cores/core.python.30520</span></span><br><span class="line">   ┌───────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">   │                                                                           │</span><br><span class="line">   │                                                                           │</span><br><span class="line">   │                                                                           │</span><br><span class="line">   │                                                                           │</span><br><span class="line">   │                                                                           │</span><br><span class="line">   │                                                                           │</span><br><span class="line">   │             [ No Source Available ]                                       │</span><br><span class="line">   │                                                                           │</span><br><span class="line">   │                                                                           │</span><br><span class="line">   │                                                                           │</span><br><span class="line">   │                                                                           │</span><br><span class="line">   │                                                                           │</span><br><span class="line">   │                                                                           │</span><br><span class="line">   └───────────────────────────────────────────────────────────────────────────┘</span><br><span class="line">None No process In:                                                L??   PC: ??</span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-linux-gnu"</span>.</span><br><span class="line">---Type  to <span class="built_in">continue</span>, or q  to quit---</span><br></pre></td></tr></table></figure>

<p>GDB 抱怨说没能找到 Python 的源代码。诚然，我可以去解决这个问题，然而，现在进程崩溃的位置是在 <code>libncursesw</code>，费劲去解决这个问题就没必要了。因此，按下回车，使其继续加载，并读入 <code>libncursesw</code> 的调试信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">   ┌──/build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c──────┐</span><br><span class="line">   │1124                                                                       │</span><br><span class="line">   │1125    static NCURSES_INLINE NCURSES_CH_T                                 │</span><br><span class="line">   │1126    ClrBlank(NCURSES_SP_DCLx WINDOW *win)                              │</span><br><span class="line">   │1127    &#123;                                                                  │</span><br><span class="line">   │1128        NCURSES_CH_T blank = blankchar;                                │</span><br><span class="line">  &gt;│1129        <span class="keyword">if</span> (back_color_erase)                                          │</span><br><span class="line">   │1130            AddAttr(blank, (AttrOf(BCE_BKGD(SP_PARM, win)) &amp; BCE_ATTRS)│</span><br><span class="line">   │1131        <span class="built_in">return</span> blank;                                                  │</span><br><span class="line">   │1132    &#125;                                                                  │</span><br><span class="line">   │1133                                                                       │</span><br><span class="line">   │1134    /*                                                                 │</span><br><span class="line">   │1135    **      ClrUpdate()                                                │</span><br><span class="line">   │1136    **                                                                 │</span><br><span class="line">   └───────────────────────────────────────────────────────────────────────────┘</span><br><span class="line">multi-thre Thread 0x7f0a3c5e87 In: doupdate            L1129 PC: 0x7f0a37aac40d</span><br><span class="line">warning: JITed object file architecture unknown is not compatible with target ar</span><br><span class="line">chitecture i386:x86-64.</span><br><span class="line">---Type &lt;<span class="built_in">return</span>&gt; to <span class="built_in">continue</span>, or q &lt;<span class="built_in">return</span>&gt; to quit---</span><br><span class="line">Core was generated by `python ./cachetop.py<span class="string">'.</span></span><br><span class="line"><span class="string">Program terminated with signal SIGSEGV, Segmentation fault.</span></span><br><span class="line"><span class="string">#0  ClrBlank (win=0x1993060)</span></span><br><span class="line"><span class="string">    at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1129</span></span><br><span class="line"><span class="string">(gdb)</span></span><br></pre></td></tr></table></figure>

<p>棒呆！</p>
<p>箭头 <code>&gt;</code> 指向的代码就是程序崩溃的位置。使用 <code>layout split</code> 命令，可以让汇编指令和源代码分开显示。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">   ┌──/build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c──────┐</span><br><span class="line">  &gt;│1129        <span class="keyword">if</span> (back_color_erase)                                          │</span><br><span class="line">   │1130            AddAttr(blank, (AttrOf(BCE_BKGD(SP_PARM, win)) &amp; BCE_ATTRS)│</span><br><span class="line">   │1131        <span class="built_in">return</span> blank;                                                  │</span><br><span class="line">   │1132    &#125;                                                                  │</span><br><span class="line">   │1133                                                                       │</span><br><span class="line">   │1134    /*                                                                 │</span><br><span class="line">   │1135    **      ClrUpdate()                                                │</span><br><span class="line">   └───────────────────────────────────────────────────────────────────────────┘</span><br><span class="line">  &gt;│0x7f0a37aac40d &lt;doupdate+301&gt;   mov    0x10(%rsi),%rdi                     │</span><br><span class="line">   │0x7f0a37aac411 &lt;doupdate+305&gt;   cmpb   <span class="variable">$0x0</span>,0x1c(%rdi)                     │</span><br><span class="line">   │0x7f0a37aac415 &lt;doupdate+309&gt;   jne    0x7f0a37aac6f7 &lt;doupdate+1047&gt;      │</span><br><span class="line">   │0x7f0a37aac41b &lt;doupdate+315&gt;   movswl 0x4(%rcx),%ecx                      │</span><br><span class="line">   │0x7f0a37aac41f &lt;doupdate+319&gt;   movswl 0x74(%rdx),%edi                     │</span><br><span class="line">   │0x7f0a37aac423 &lt;doupdate+323&gt;   mov    %rax,0x40(%rsp)                     │</span><br><span class="line">   │0x7f0a37aac428 &lt;doupdate+328&gt;   movl   <span class="variable">$0x20</span>,0x48(%rsp)                    │</span><br><span class="line">   │0x7f0a37aac430 &lt;doupdate+336&gt;   movl   <span class="variable">$0x0</span>,0x4c(%rsp)                     │</span><br><span class="line">   └───────────────────────────────────────────────────────────────────────────┘</span><br><span class="line">multi-thre Thread 0x7f0a3c5e87 In: doupdate            L1129 PC: 0x7f0a37aac40d</span><br><span class="line"></span><br><span class="line">chitecture i386:x86-64.</span><br><span class="line">Core was generated by `python ./cachetop.py<span class="string">'.</span></span><br><span class="line"><span class="string">Program terminated with signal SIGSEGV, Segmentation fault.</span></span><br><span class="line"><span class="string">---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---</span></span><br><span class="line"><span class="string">#0  ClrBlank (win=0x1993060)</span></span><br><span class="line"><span class="string">    at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1129</span></span><br><span class="line"><span class="string">(gdb) layout split</span></span><br></pre></td></tr></table></figure>

<p>Law 在单步回退中展示了如何使用 TUI。你可以想象一下，在代码执行的过程中，同时呈现汇编码和源代码是怎样的光景。</p>
<h2 id="十四-·-外部工具：cscope"><a href="#十四-·-外部工具：cscope" class="headerlink" title="十四 · 外部工具：cscope"></a>十四 · 外部工具：<code>cscope</code></h2><p>我依然需要搞清楚 <code>back_color_erase</code> 到底发生了什么。当然，我可以在 GDB 中使用 <code>search</code> 命令，查找 <code>back_color_erase</code> 是在哪里定义的。不过，我更偏好使用名为 <code>cscope</code> 的外部工具。这是一个贝尔实验室在上世纪 80 年代发明的基于文本的代码浏览器。如果你有喜欢的现代 IDE 工具，那么就用你喜欢的就好。</p>
<p>首先，设置 <code>cscope</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apt-get install -y cscope</span></span><br><span class="line"><span class="comment"># wget http://archive.ubuntu.com/ubuntu/pool/main/n/ncurses/ncurses_6.0+20160213.orig.tar.gz</span></span><br><span class="line"><span class="comment"># tar xvf ncurses_6.0+20160213.orig.tar.gz</span></span><br><span class="line"><span class="comment"># cd ncurses-6.0-20160213</span></span><br><span class="line"><span class="comment"># cscope -bqR</span></span><br><span class="line"><span class="comment"># cscope -dq</span></span><br></pre></td></tr></table></figure>

<p>此处 <code>cscope -bqR</code> 创建了查找数据库，而 <code>cscope -dq</code> 则启动之。</p>
<p>搜索 <code>back_color_erase</code> 的定义：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Cscope version 15.8b                                   Press the ? key <span class="keyword">for</span> <span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Find this C symbol:</span><br><span class="line">Find this global definition: back_color_erase</span><br><span class="line">Find <span class="built_in">functions</span> called by this <span class="keyword">function</span>:</span><br><span class="line">Find <span class="built_in">functions</span> calling this <span class="keyword">function</span>:</span><br><span class="line">Find this text string:</span><br><span class="line">Change this text string:</span><br><span class="line">Find this egrep pattern:</span><br><span class="line">Find this file:</span><br><span class="line">Find files <span class="comment">#including this file:</span></span><br><span class="line">Find assignments to this symbol:</span><br></pre></td></tr></table></figure>

<p>敲回车。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> non_dest_scroll_region         CUR Booleans[26]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> can_change                     CUR Booleans[27]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> back_color_erase               CUR Booleans[28]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> hue_lightness_saturation       CUR Booleans[29]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> col_addr_glitch                CUR Booleans[30]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cr_cancels_micro_mode          CUR Booleans[31]</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>好吧……这是一个用 <code>#define</code> 定义的宏变量。（就不能大写吗？摔！）</p>
<p>那么，<code>CUR</code> 又是什么呢？我们继续搜索。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CUR cur_term-&gt;type.</span></span><br></pre></td></tr></table></figure>

<p>好嘛，至少这个 <code>#define</code> 定义的宏是大写的。</p>
<p>碰见 <code>cur_term</code> 了——之前我们在单步调试汇编指令和检查寄存器状态的时候有看到过它。那么它是啥咧？</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0 &amp;&amp; !0</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="title">NCURSES_EXPORT_VAR</span><span class="params">(TERMINAL *)</span> cur_term</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> 0</span></span><br><span class="line">NCURSES_WRAPPED_VAR(TERMINAL *, cur_term);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cur_term   NCURSES_PUBLIC_VAR(cur_term())</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="title">NCURSES_EXPORT_VAR</span><span class="params">(TERMINAL *)</span> cur_term</span>;     <span class="comment">// &lt;- here</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><code>cscope</code> 在 <code>/usr/include/term.h</code> 中找到了它。我在我认为真正起作用的定义处，用注释做了标记。为什么会有 <code>if 0 &amp;&amp; !0 ... elif 0</code> 这种那奇怪的写法，我也不知道……（但总之要阅读更多的代码）有时，程序员会使用 <code>#if 0</code> 使调试用代码在生产环境中不生效。但这部分代码，看上去是自动生成的。</p>
<p>继续搜索 <code>NCURSES_EXPORT_VAR</code>，会有新的发现。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> NCURSES_EXPORT_VAR(type) NCURSES_IMPEXP type</span></span><br></pre></td></tr></table></figure>

<p>以及 <code>NCURSES_IMPEXP</code>……</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">term</span> &#123;</span>       <span class="comment">/* describe an actual terminal */</span></span><br><span class="line">    TERMTYPE    type;       <span class="comment">/* terminal type description */</span></span><br><span class="line">    <span class="keyword">short</span>   Filedes;    <span class="comment">/* file description being written to */</span></span><br><span class="line">    TTY     Ottyb,      <span class="comment">/* original state of the terminal */</span></span><br><span class="line">        Nttyb;      <span class="comment">/* current state of the terminal */</span></span><br><span class="line">    <span class="keyword">int</span>     _baudrate;  <span class="comment">/* used to compute padding */</span></span><br><span class="line">    <span class="keyword">char</span> *      _termname;      <span class="comment">/* used for termname() */</span></span><br><span class="line">&#125; TERMINAL;</span><br></pre></td></tr></table></figure>

<p>哈！这回 <code>TERMINAL</code> 是大写的了。在这坨宏当中，这算是容易追踪的了。</p>
<p>好了，现在到底是谁设置了 <code>cur_term</code> 呢？想想看，我们遇到的问题，是因为 <code>cur_term</code> 被设置为 <code>0x0</code>，这可能是没有初始化导致的，也有可能是显式设置导致的。顺着代码检查，可能会有新的线索。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Find this C symbol: cur_term</span><br><span class="line">Find this global definition:</span><br><span class="line">Find <span class="built_in">functions</span> called by this <span class="keyword">function</span>:</span><br><span class="line">Find <span class="built_in">functions</span> calling this <span class="keyword">function</span>:</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>按下回车，得到结果。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">NCURSES_EXPORT(TERMINAL *)</span><br><span class="line">NCURSES_SP_NAME(set_curterm) (NCURSES_SP_DCLx TERMINAL * termp)</span><br><span class="line">&#123;</span><br><span class="line">    TERMINAL *oldterm;</span><br><span class="line"></span><br><span class="line">    T((T_CALLED(<span class="string">"set_curterm(%p)"</span>), (<span class="keyword">void</span> *) termp));</span><br><span class="line"></span><br><span class="line">    _nc_lock_global(curses);</span><br><span class="line">    oldterm = cur_term;</span><br><span class="line">    <span class="keyword">if</span> (SP_PARM)</span><br><span class="line">    SP_PARM-&gt;_term = termp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_REENTRANT</span></span><br><span class="line">    CurTerm = termp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    cur_term = termp;   <span class="comment">// &lt;- here</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>同样，我对实际生效的部分做了标记。尽管函数名字被包在宏变量当中，但是我们至少知道 <code>cur_term</code> 是如何设置的了——通过 <code>set_curterm()</code> 函数。这个函数是没有被调用吗？</p>
<h2 id="十五-·-外部工具：perf-tools-ftrace-uprobes"><a href="#十五-·-外部工具：perf-tools-ftrace-uprobes" class="headerlink" title="十五 · 外部工具：perf-tools/ftrace/uprobes"></a>十五 · 外部工具：<code>perf-tools/ftrace/uprobes</code></h2><p>我稍后将介绍如何使用 GDB 解决这个问题，但我想试着用我的 <a href="https://github.com/brendangregg/perf-tools" target="_blank" rel="noopener">perf-tools</a> 工具集当中的 <code>uprobe</code> 工具来解决问题。它使用了 Linux 提供的 <code>ftrace</code> 以及 <code>uprobes</code> 两个工具。使用跟踪器的好处是不需要像 GDB 那样暂停目标进程——当然，在这个例子里这没所谓就是了。此外，使用跟踪器追踪一个事件和追踪成百上千个事件是一样的。</p>
<p>为此，我需要追踪 <code>set_curterm</code> 的调用，并且打印其首个参数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /apps/perf-tools/bin/uprobe 'p:/lib/x86_64-linux-gnu/libncursesw.so.5:set_curterm %di'</span></span><br><span class="line">ERROR: missing symbol <span class="string">"set_curterm"</span> <span class="keyword">in</span> /lib/x86_64-linux-gnu/libncursesw.so.5</span><br></pre></td></tr></table></figure>

<p>好吧，在 <code>libncursesw</code> 里没见着有 <code>set_curterm</code>。那么它在哪里呢？我们可以用 GDB 或者 <code>objdump</code> 查找一下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info symbol set_curterm</span><br><span class="line">set_curterm <span class="keyword">in</span> section .text of /lib/x86_64-linux-gnu/libtinfo.so.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># objdump -tT /lib/x86_64-linux-gnu/libncursesw.so.5 | grep cur_term</span></span><br><span class="line">0000000000000000      DO *UND*  0000000000000000  NCURSES_TINFO_5.0.19991023 cur_term</span><br><span class="line"><span class="comment"># objdump -tT /lib/x86_64-linux-gnu/libtinfo.so.5 | grep cur_term</span></span><br><span class="line">0000000000228948 g    DO .bss   0000000000000008  NCURSES_TINFO_5.0.19991023 cur_term</span><br></pre></td></tr></table></figure>

<p>显而易见，在此处 GDB 更好使些。如果你足够仔细的话，你会发现，这个函数定义在 <code>libtinfo</code> 当中。那么，让我们尝试在 <code>libtinfo</code>　中去追踪 <code>set_curterm</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /apps/perf-tools/bin/uprobe 'p:/lib/x86_64-linux-gnu/libtinfo.so.5:set_curterm %di'</span></span><br><span class="line">Tracing uprobe set_curterm (p:set_curterm /lib/x86_64-linux-gnu/libtinfo.so.5:0xfa80 %di). Ctrl-C to end.</span><br><span class="line">          python-31617 [007] d... 24236402.719959: set_curterm: (0x7f116fcc2a80) arg1=0x1345d70</span><br><span class="line">          python-31617 [007] d... 24236402.720033: set_curterm: (0x7f116fcc2a80) arg1=0x13a22e0</span><br><span class="line">          python-31617 [007] d... 24236402.723804: set_curterm: (0x7f116fcc2a80) arg1=0x14cdfa0</span><br><span class="line">          python-31617 [007] d... 24236402.723838: set_curterm: (0x7f116fcc2a80) arg1=0x0</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>

<p>这会没问题了。显而易见，<code>set_curterm</code> 确实是有被调用的，并且被调用了 4 次。在最后一次调用时（之后进程就崩溃了），第一个参数是 <code>0x0</code>，看起来似乎就是问题所在了。</p>
<p>至于为什么要打印 <code>%di</code> 这个寄存器中的值，是因为我们的程序运行在 <code>x86_64</code> 平台。使用 <code>man syscall</code> 可以看到有用的信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># man syscall</span></span><br><span class="line">[...]</span><br><span class="line">       arch/ABI      arg1  arg2  arg3  arg4  arg5  arg6  arg7  Notes</span><br><span class="line">       ──────────────────────────────────────────────────────────────────</span><br><span class="line">       arm/OABI      a1    a2    a3    a4    v1    v2    v3</span><br><span class="line">       arm/EABI      r0    r1    r2    r3    r4    r5    r6</span><br><span class="line">       arm64         x0    x1    x2    x3    x4    x5    -</span><br><span class="line">       blackfin      R0    R1    R2    R3    R4    R5    -</span><br><span class="line">       i386          ebx   ecx   edx   esi   edi   ebp   -</span><br><span class="line">       ia64          out0  out1  out2  out3  out4  out5  -</span><br><span class="line">       mips/o32      a0    a1    a2    a3    -     -     -     See below</span><br><span class="line">       mips/n32,64   a0    a1    a2    a3    a4    a5    -</span><br><span class="line">       parisc        r26   r25   r24   r23   r22   r21   -</span><br><span class="line">       s390          r2    r3    r4    r5    r6    r7    -</span><br><span class="line">       s390x         r2    r3    r4    r5    r6    r7    -</span><br><span class="line">       sparc/32      o0    o1    o2    o3    o4    o5    -</span><br><span class="line">       sparc/64      o0    o1    o2    o3    o4    o5    -</span><br><span class="line">       x86_64        rdi   rsi   rdx   r10   r8    r9    -</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>我还想去看看为什么会在调用 <code>set_curterm</code> 时传入 <code>0x0</code> 作为参数，不过当前 <code>ftrace</code> 不支持调用栈的查询。</p>
<h2 id="十六-·-外部工具：bcc-BPF"><a href="#十六-·-外部工具：bcc-BPF" class="headerlink" title="十六 · 外部工具：bcc/BPF"></a>十六 · 外部工具：<code>bcc</code>/BPF</h2><p>考虑到我们正在调试 <code>bcc</code> 工具 <code>cachetop.py</code>，那么使用 <code>bcc</code> 提供的 <code>trace.py</code> 来追踪函数调用是个不错的选择。它和刚才的 <code>uprobe</code> 工具有类似的功能。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./trace.py 'p:tinfo:set_curterm "%d", arg1'</span></span><br><span class="line">TIME     PID    COMM         FUNC             -</span><br><span class="line">01:00:20 31698  python       set_curterm      38018416</span><br><span class="line">01:00:20 31698  python       set_curterm      38396640</span><br><span class="line">01:00:20 31698  python       set_curterm      39624608</span><br><span class="line">01:00:20 31698  python       set_curterm      0</span><br></pre></td></tr></table></figure>

<p>没错！我们在用 <code>bcc</code> 来调试 <code>bcc</code>。</p>
<p>如果你之前未曾使用过 <a href="https://github.com/iovisor/bcc" target="_blank" rel="noopener"><code>bcc</code></a>，那么我推荐你试试看。它有面向 Python 和 Lua 的接口，提供了在 Linux 4.x 系列中的 BPF 跟踪特性。简单来说，它让很多以前无法或者难以实现的性能工具变得可行。在 <a href="http://www.brendangregg.com/blog/2016-06-14/ubuntu-xenial-bcc-bpf.html" target="_blank" rel="noopener">Ubuntu Xenial</a> 上有我关于此的介绍。</p>
<h2 id="十七-·-更多的断点"><a href="#十七-·-更多的断点" class="headerlink" title="十七 · 更多的断点"></a>十七 · 更多的断点</h2><p>我本该用 GDB 给 <code>set_curterm</code> 设置断点的，但是绕道去 <code>ftrace</code> 和 BPF 也时很有趣的事情。</p>
<p>回到 GDB。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb `which python`</span></span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1</span><br><span class="line">[...]</span><br><span class="line">(gdb) b set_curterm</span><br><span class="line">Function <span class="string">"set_curterm"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 1 (set_curterm) pending.</span><br><span class="line">(gdb) r cachetop.py</span><br><span class="line">Starting program: /usr/bin/python cachetop.py</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=termp@entry=0xa43150) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">80  &#123;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=termp@entry=0xab5870) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">80  &#123;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=termp@entry=0xbecb90) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">80  &#123;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">80  &#123;</span><br></pre></td></tr></table></figure>

<p>好了，在断点处，我们看到 <code>set_curterm</code> 被传入了参数 <code>termp=0x0</code>。幸好能有这些调试信息，否则，我就不得不在各个断点去打印寄存器状态了。</p>
<p>现在，查看逆向追溯调用栈，应当可以看到是哪个函数将 <code>0x0</code> 传给了 <code>set_curterm</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  set_curterm (termp=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span></span><br><span class="line"><span class="comment">#1  0x00007ffff5a44e75 in llvm::sys::Process::FileDescriptorHasColors(int) () from /usr/lib/x86_64-linux-gnu/libbcc.so.0</span></span><br><span class="line"><span class="comment">#2  0x00007ffff45cabb8 in clang::driver::tools::Clang::ConstructJob(clang::driver::Compilation&amp;, clang::driver::JobAction const&amp;, clang::driver::InputInfo const&amp;, llvm::SmallVector&lt;clang::driver::InputInfo, 4u&gt; const&amp;, llvm::opt::ArgList const&amp;, char const*) const () from /usr/lib/x86_64-linux-gnu/libbcc.so.0</span></span><br><span class="line"><span class="comment">#3  0x00007ffff456ffa5 in clang::driver::Driver::BuildJobsForAction(clang::driver::Compilation&amp;, clang::driver::Action const*, clang::driver::ToolChain const*, char const*, bool, bool, char const*, clang::driver::InputInfo&amp;) const () from /usr/lib/x86_64-linux-gnu/libbcc.so.0</span></span><br><span class="line"><span class="comment">#4  0x00007ffff4570501 in clang::driver::Driver::BuildJobs(clang::driver::Compilation&amp;) const () from /usr/lib/x86_64-linux-gnu/libbcc.so.0</span></span><br><span class="line"><span class="comment">#5  0x00007ffff457224a in clang::driver::Driver::BuildCompilation(llvm::ArrayRef&lt;char const*&gt;) () from /usr/lib/x86_64-linux-gnu/libbcc.so.0</span></span><br><span class="line"><span class="comment">#6  0x00007ffff4396cda in ebpf::ClangLoader::parse(std::unique_ptr&lt;llvm::Module, std::default_delete&lt;llvm::Module&gt; &gt;*, std::unique_ptr&lt;std::vector&lt;ebpf::TableDesc, std::allocator&lt;ebpf::TableDesc&gt; &gt;, std::default_delete&lt;std::vector&lt;ebpf::TableDesc, std::allocator&lt;ebpf::TableDesc&gt; &gt; &gt; &gt;*, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, bool, char const**, int) () from /usr/lib/x86_64-linux-gnu/libbcc.so.0</span></span><br><span class="line"><span class="comment">#7  0x00007ffff4344314 in ebpf::BPFModule::load_cfile(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, bool, char const**, int) ()</span></span><br><span class="line">   from /usr/lib/x86_64-linux-gnu/libbcc.so.0</span><br><span class="line"><span class="comment">#8  0x00007ffff4349e5e in ebpf::BPFModule::load_string(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, char const**, int) ()</span></span><br><span class="line">   from /usr/lib/x86_64-linux-gnu/libbcc.so.0</span><br><span class="line"><span class="comment">#9  0x00007ffff43430c8 in bpf_module_create_c_from_string () from /usr/lib/x86_64-linux-gnu/libbcc.so.0</span></span><br><span class="line"><span class="comment">#10 0x00007ffff690ae40 in ffi_call_unix64 () from /usr/lib/x86_64-linux-gnu/libffi.so.6</span></span><br><span class="line"><span class="comment">#11 0x00007ffff690a8ab in ffi_call () from /usr/lib/x86_64-linux-gnu/libffi.so.6</span></span><br><span class="line"><span class="comment">#12 0x00007ffff6b1a68c in _ctypes_callproc () from /usr/lib/python2.7/lib-dynload/_ctypes.x86_64-linux-gnu.so</span></span><br><span class="line"><span class="comment">#13 0x00007ffff6b1ed82 in ?? () from /usr/lib/python2.7/lib-dynload/_ctypes.x86_64-linux-gnu.so</span></span><br><span class="line"><span class="comment">#14 0x00000000004b1153 in PyObject_Call ()</span></span><br><span class="line"><span class="comment">#15 0x00000000004ca5ca in PyEval_EvalFrameEx ()</span></span><br><span class="line"><span class="comment">#16 0x00000000004c2e05 in PyEval_EvalCodeEx ()</span></span><br><span class="line"><span class="comment">#17 0x00000000004def08 in ?? ()</span></span><br><span class="line"><span class="comment">#18 0x00000000004b1153 in PyObject_Call ()</span></span><br><span class="line"><span class="comment">#19 0x00000000004f4c3e in ?? ()</span></span><br><span class="line"><span class="comment">#20 0x00000000004b1153 in PyObject_Call ()</span></span><br><span class="line"><span class="comment">#21 0x00000000004f49b7 in ?? ()</span></span><br><span class="line"><span class="comment">#22 0x00000000004b6e2c in ?? ()</span></span><br><span class="line"><span class="comment">#23 0x00000000004b1153 in PyObject_Call ()</span></span><br><span class="line"><span class="comment">#24 0x00000000004ca5ca in PyEval_EvalFrameEx ()</span></span><br><span class="line"><span class="comment">#25 0x00000000004c2e05 in PyEval_EvalCodeEx ()</span></span><br><span class="line"><span class="comment">#26 0x00000000004def08 in ?? ()</span></span><br><span class="line"><span class="comment">#27 0x00000000004b1153 in PyObject_Call ()</span></span><br><span class="line"><span class="comment">#28 0x00000000004c73ec in PyEval_EvalFrameEx ()</span></span><br><span class="line"><span class="comment">#29 0x00000000004c2e05 in PyEval_EvalCodeEx ()</span></span><br><span class="line"><span class="comment">#30 0x00000000004caf42 in PyEval_EvalFrameEx ()</span></span><br><span class="line"><span class="comment">#31 0x00000000004c2e05 in PyEval_EvalCodeEx ()</span></span><br><span class="line"><span class="comment">#32 0x00000000004c2ba9 in PyEval_EvalCode ()</span></span><br><span class="line"><span class="comment">#33 0x00000000004f20ef in ?? ()</span></span><br><span class="line"><span class="comment">#34 0x00000000004eca72 in PyRun_FileExFlags ()</span></span><br><span class="line"><span class="comment">#35 0x00000000004eb1f1 in PyRun_SimpleFileExFlags ()</span></span><br><span class="line"><span class="comment">#36 0x000000000049e18a in Py_Main ()</span></span><br><span class="line"><span class="comment">#37 0x00007ffff7811830 in __libc_start_main (main=0x49daf0 &lt;main&gt;, argc=2, argv=0x7fffffffdfb8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;,</span></span><br><span class="line">    stack_end=0x7fffffffdfa8) at ../csu/libc-start.c:291</span><br><span class="line"><span class="comment">#38 0x000000000049da19 in _start ()</span></span><br></pre></td></tr></table></figure>

<p>唔……这回有更多信息了。<code>set_curterm</code> 是被 <code>llvm::sys::Process::FileDescriptorHasColors()</code> 调用的，<code>llvm</code> 编译器有问题？</p>
<h2 id="十八-·-外部工具：再次使用-cscope"><a href="#十八-·-外部工具：再次使用-cscope" class="headerlink" title="十八 · 外部工具：再次使用 cscope"></a>十八 · 外部工具：再次使用 <code>cscope</code></h2><p>这回，我们需要使用 <code>cscope</code> 看看 <code>llvm</code> 的代码。<code>FileDescriptorHasColors</code> 函数是酱婶的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">terminalHasColors</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</span><br><span class="line">[...]</span><br><span class="line">  <span class="comment">// Now extract the structure allocated by setupterm and free its memory</span></span><br><span class="line">  <span class="comment">// through a really silly dance.</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">term</span> *<span class="title">termp</span> = <span class="title">set_curterm</span>((<span class="title">struct</span> <span class="title">term</span> *)<span class="title">nullptr</span>);</span></span><br><span class="line">  (<span class="keyword">void</span>)del_curterm(termp); <span class="comment">// Drop any errors here.</span></span><br></pre></td></tr></table></figure>

<p>在早先的版本里，该函数是这样定义的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">terminalHasColors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">const</span> <span class="keyword">char</span> *term = <span class="built_in">std</span>::getenv(<span class="string">"TERM"</span>)) &#123;</span><br><span class="line">    <span class="comment">// Most modern terminals support ANSI escape sequences for colors.</span></span><br><span class="line">    <span class="comment">// We could check terminfo, or have a list of known terms that support</span></span><br><span class="line">    <span class="comment">// colors, but that would be overkill.</span></span><br><span class="line">    <span class="comment">// The user can always ask for no colors by setting TERM to dumb, or</span></span><br><span class="line">    <span class="comment">// using a commandline flag.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strcmp</span>(term, <span class="string">"dumb"</span>) != <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/llvm-mirror/llvm/commit/d485e7bd7639cd6b39c6113a30fbc3cdc8c41c4c#diff-a4fb6575a290937bc9142e3d7efc8989" target="_blank" rel="noopener">给 <code>set_curterm</code> 传入 <code>nullptr</code></a> 着实是个坏主意。</p>
<h2 id="十九-·-复写内存"><a href="#十九-·-复写内存" class="headerlink" title="十九 · 复写内存"></a>十九 · 复写内存</h2><p>为了确定嫌疑，同时试着看看有没有可能的临时解决方案，我会尝试在异常调用 <code>set_curterm</code> 时复写修改内存。</p>
<p>首先，我们在 GDB 里跟踪程序，并在 <code>set_curterm</code> 处设置断点，直到调用它时传入了 <code>0x0</code> 作为参数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb `which python`</span></span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1</span><br><span class="line">[...]</span><br><span class="line">(gdb) b set_curterm</span><br><span class="line">Function <span class="string">"set_curterm"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 1 (set_curterm) pending.</span><br><span class="line">(gdb) r cachetop.py</span><br><span class="line">Starting program: /usr/bin/python cachetop.py</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=termp@entry=0xa43150) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">80      &#123;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=termp@entry=0xab5870) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">80      &#123;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=termp@entry=0xbecb90) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">80      &#123;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">80      &#123;</span><br></pre></td></tr></table></figure>

<p>此时，我要使用 <code>set</code> 命令，复写相关的内存：使用之前传入 <code>set_curterm</code> 并正确执行的参数 <code>0xbecb90</code> 替代 <code>0x0</code>——当然，希望这一地址仍旧是合法的。</p>
<blockquote>
<p><strong>警告</strong>，复写内存是十分危险的！GDB 不会向你确认，「你确定吗」。如果你搞错了，或者输入时手滑了，那么进程就会崩溃。好一点的情况，进程当时就崩溃了。糟糕的情况，可能在如果按时间后才崩溃，而谁也不知道是怎么了。</p>
</blockquote>
<p>此处，我是在一台试验用机器上进行调试。因为没有敏感数据，所以我冒险一试。此处，我将用 <code>p/x</code> 以十六进制的形式打印寄存器 <code>%rdi</code> 中的内容，并用 <code>set</code> 命令将其设置为之前可用的值，并检查寄存器状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p/x <span class="variable">$rdi</span></span><br><span class="line"><span class="variable">$1</span> = 0x0</span><br><span class="line">(gdb) <span class="built_in">set</span> <span class="variable">$rdi</span>=0xbecb90</span><br><span class="line">(gdb) p/x <span class="variable">$rdi</span></span><br><span class="line"><span class="variable">$2</span> = 0xbecb90</span><br><span class="line">(gdb) i r</span><br><span class="line">rax            0x100    256</span><br><span class="line">rbx            0x1  1</span><br><span class="line">rcx            0xe71    3697</span><br><span class="line">rdx            0x0  0</span><br><span class="line">rsi            0x7ffff5dd45d3   140737318307283</span><br><span class="line">rdi            0xbecb90 12503952</span><br><span class="line">rbp            0x100    0x100</span><br><span class="line">rsp            0x7fffffffa5b8   0x7fffffffa5b8</span><br><span class="line">r8             0xbf0050 12517456</span><br><span class="line">r9             0x1999999999999999   1844674407370955161</span><br><span class="line">r10            0xbf0040 12517440</span><br><span class="line">r11            0x7ffff7bb4b78   140737349634936</span><br><span class="line">r12            0xbecb70 12503920</span><br><span class="line">r13            0xbeaea0 12496544</span><br><span class="line">r14            0x7fffffffa9a0   140737488333216</span><br><span class="line">r15            0x7fffffffa8a0   140737488332960</span><br><span class="line">rip            0x7ffff3c76a80   0x7ffff3c76a80 &lt;set_curterm&gt;</span><br><span class="line">eflags         0x246    [ PF ZF IF ]</span><br><span class="line">cs             0x33 51</span><br><span class="line">ss             0x2b 43</span><br><span class="line">ds             0x0  0</span><br><span class="line">es             0x0  0</span><br><span class="line">fs             0x0  0</span><br><span class="line">gs             0x0  0</span><br></pre></td></tr></table></figure>

<p>（当然，因为有调试信息，所以我本没必要直接操作寄存器 <code>%rdi</code> 的值，我可以直接设置函数参数 <code>termp</code> 的值）</p>
<p>现在 <code>%rdi</code> 的值已经更新，其他寄存器看上去也没什么问题。于是我们让程序继续执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=termp@entry=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">80  &#123;</span><br></pre></td></tr></table></figure>

<p>赞！当前对 <code>set_curterm</code> 的调用通过了，没有引发段错误。不过，下一次调用 <code>set_curterm</code> 又传入了 <code>0x0</code>，我们故技重施。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">set</span> <span class="variable">$rdi</span>=0xbecb90</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">warning: JITed object file architecture unknown is not compatible with target architecture i386:x86-64.</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x00007ffff34ad411 <span class="keyword">in</span> ClrBlank (win=0xaea060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1129</span><br><span class="line">1129        <span class="keyword">if</span> (back_color_erase)</span><br></pre></td></tr></table></figure>

<p>啊哈！这次修改内存得到了另一个段错误。不过，虽然如此，当前的问题至少是解决了。</p>
<h2 id="二十-·-条件断点"><a href="#二十-·-条件断点" class="headerlink" title="二十 · 条件断点"></a>二十 · 条件断点</h2><p>在之前的章节中，我不得不连续使用 3 次 <code>continue</code> 以便到达我真正感兴趣的那次函数调用。如果相关函数被调用了上百次，那么我会考虑使用条件断点。以下是一个示例。</p>
<p>首先，我会如常启动程序并为 <code>set_curterm</code> 设置断点。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb `which python`</span></span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1</span><br><span class="line">[...]</span><br><span class="line">(gdb) b set_curterm</span><br><span class="line">Function <span class="string">"set_curterm"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 1 (set_curterm) pending.</span><br><span class="line">(gdb) r cachetop.py</span><br><span class="line">Starting program: /usr/bin/python cachetop.py</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=termp@entry=0xa43150) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">80  &#123;</span><br></pre></td></tr></table></figure>

<p>现在，我要将断点 1 转换为条件断点，使其只在 <code>%rdi</code> 的值为 <code>0x0</code> 时生效。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) cond 1 <span class="variable">$rdi</span>==0x0</span><br><span class="line">(gdb) i b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">1       breakpoint     keep y   0x00007ffff3c76a80 <span class="keyword">in</span> set_curterm at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">    stop only <span class="keyword">if</span> <span class="variable">$rdi</span>==0x0</span><br><span class="line">    breakpoint already hit 1 time</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>吼啊！通过使用 <code>cond</code> (<code>conditional</code>)，我将断点 1 设置为条件断点。因此，当断点 1 下一次生效时，就是 <code>set_curterm</code> 接受的第一个参数值为 <code>0x0</code> 的时候。此外，我用了 <code>i b</code> (<code>info breakpoints</code>) 列出了所有断点的信息。</p>
<p>这里需要考虑，为什么我不在设置断点后的第一时间就将其设置为条件断点。这是因为，我发现对于程序尚未执行时设置的被延迟的断点来说，这些条件不会生效——至少当前的 GDB 版本是这样。（也有可能是我搞错了）</p>
<h2 id="廿一-·-直接返回"><a href="#廿一-·-直接返回" class="headerlink" title="廿一 · 直接返回"></a>廿一 · 直接返回</h2><p>我也曾尝试了另一个和复写内存类似的方案。不过，这次我不打算修改内存中的数据，而是修改指令。</p>
<blockquote>
<p><strong>警告</strong>：先前的警告在此处同样适用。</p>
</blockquote>
<p>我将如先前一样，停在 <code>set_curterm</code> 的 <code>0x0</code> 调用处，而后适用 GDB 的 <code>ret</code> (<code>return</code>) 命令跳过函数的执行，直接返回。此处的考量是，如果函数未执行，则全局变量 <code>curterm</code> 不会被设置为 <code>0x0</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line"></span><br><span class="line">(gdb) ret</span><br><span class="line">Make set_curterm <span class="built_in">return</span> now? (y or n) y</span><br><span class="line"><span class="comment">#0  0x00007ffff5a44e75 in llvm::sys::Process::FileDescriptorHasColors(int) () from /usr/lib/x86_64-linux-gnu/libbcc.so.0</span></span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">                                                    _nc_free_termtype (ptr=ptr@entry=0x100) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/free_ttype.c:52</span><br><span class="line">52      FreeIfNeeded(ptr-&gt;str_table);</span><br></pre></td></tr></table></figure>

<p>好嘛，进程又挂了……这是进程崩掉之后的状态。</p>
<p>度过更多代码之后，我决定再试试看。我想试着连续执行两次 <code>ret</code>，以免 <code>set_curterm</code> 的调用者被不完整的调用搞坏了。再次强调：这只是一个非常 hacky 的实验，在生产环境中请慎重执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, set_curterm (termp=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80</span><br><span class="line">80  &#123;</span><br><span class="line">(gdb) ret</span><br><span class="line">Make set_curterm <span class="built_in">return</span> now? (y or n) y</span><br><span class="line"><span class="comment">#0  0x00007ffff5a44e75 in llvm::sys::Process::FileDescriptorHasColors(int) () from /usr/lib/x86_64-linux-gnu/libbcc.so.0</span></span><br><span class="line">(gdb) ret</span><br><span class="line">Make selected stack frame <span class="built_in">return</span> now? (y or n) y</span><br><span class="line"><span class="comment">#0  0x00007ffff45cabb8 in clang::driver::tools::Clang::ConstructJob(clang::driver::Compilation&amp;, clang::driver::JobAction const&amp;, clang::driver::InputInfo const&amp;, llvm::SmallVector const&amp;, llvm::opt::ArgList const&amp;, char const*) const () from /usr/lib/x86_64-linux-gnu/libbcc.so.0</span></span><br><span class="line">(gdb) c</span><br></pre></td></tr></table></figure>

<p>这回，整个屏幕都白了，然后停住……之后显示出了如下结果。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">07:44:22 Buffers MB: 61 / Cached MB: 1246</span><br><span class="line">PID      UID      CMD              HITS     MISSES   DIRTIES  READ_HIT%  WRITE_HIT%</span><br><span class="line">    2742 root     systemd-logind          3       66        2       1.4%      95.7%</span><br><span class="line">   15836 root     kworker/u30:1           7        0        1      85.7%       0.0%</span><br><span class="line">    2736 messageb dbus-daemon             8       66        2       8.1%      89.2%</span><br><span class="line">       1 root     systemd                15        0        0     100.0%       0.0%</span><br><span class="line">    2812 syslog   rs:main Q:Reg          16       66        8       9.8%      80.5%</span><br><span class="line">     435 root     systemd-journal        32       66        8      24.5%      67.3%</span><br><span class="line">    2740 root     accounts-daemon       113       66        2      62.0%      36.9%</span><br><span class="line">   15847 root     bash                  160        0        1      99.4%       0.0%</span><br><span class="line">   15864 root     lesspipe              306        0        2      99.3%       0.0%</span><br><span class="line">   15854 root     bash                  309        0        2      99.4%       0.0%</span><br><span class="line">   15856 root     bash                  309        0        2      99.4%       0.0%</span><br><span class="line">   15866 root     bash                  309        0        2      99.4%       0.0%</span><br><span class="line">   15867 root     bash                  309        0        2      99.4%       0.0%</span><br><span class="line">   15860 root     bash                  313        0        2      99.4%       0.0%</span><br><span class="line">   15868 root     bash                  341        0        2      99.4%       0.0%</span><br><span class="line">   15858 root     uname                 452        0        2      99.6%       0.0%</span><br><span class="line">   15858 root     bash                  453        0        2      99.6%       0.0%</span><br><span class="line">   15866 root     dircolors             464        0        2      99.6%       0.0%</span><br><span class="line">   15861 root     basename              465        0        2      99.6%       0.0%</span><br><span class="line">   15864 root     dirname               468        0        2      99.6%       0.0%</span><br><span class="line">   15856 root     ls                    476        0        2      99.6%       0.0%</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>帅！炸！搞定啦！</p>
<h2 id="廿二-·-更好的方案"><a href="#廿二-·-更好的方案" class="headerlink" title="廿二 · 更好的方案"></a>廿二 · 更好的方案</h2><p>我将调试过程的结果提交在 <a href="https://github.com/iovisor/bcc/pull/615" target="_blank" rel="noopener">github</a> 上。这是因为，一方面 BPF 的首席工程师 Alexei Starovoitov 也是 llvm 方面的专家，另一方面这个问题的根源似乎是 llvm 的一个 bug。当我在把指令和数据搞得乱七八糟时，他建议我在编译 <code>bcc</code> 时加入 llvm 的参数 <code>-fno-color-diagnostics</code> 即可绕过这一问题。搞定！这确实能解决问题。因此我将其加入了 <code>bcc</code> 的代码库作为暂时的解决方案，并期待 llvm 解决这个 bug。</p>
<h2 id="廿三-·-关于-Python-的环境"><a href="#廿三-·-关于-Python-的环境" class="headerlink" title="廿三 · 关于 Python 的环境"></a>廿三 · 关于 Python 的环境</h2><p>至此，我们已经解决了问题。不过，（译注：有强迫症的）你可能还想要让整个调用栈看起来完好。</p>
<p>为此，你需要安装 <code>python-dbg</code> 软件包。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apt-get install -y python-dbg</span></span><br><span class="line">Reading package lists... Done</span><br><span class="line">[...]</span><br><span class="line">The following additional packages will be installed:</span><br><span class="line">  libpython-dbg libpython2.7-dbg python2.7-dbg</span><br><span class="line">Suggested packages:</span><br><span class="line">  python2.7-gdbm-dbg python2.7-tk-dbg python-gdbm-dbg python-tk-dbg</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  libpython-dbg libpython2.7-dbg python-dbg python2.7-dbg</span><br><span class="line">0 upgraded, 4 newly installed, 0 to remove and 20 not upgraded.</span><br><span class="line">Need to get 11.9 MB of archives.</span><br><span class="line">After this operation, 36.4 MB of additional disk space will be used.</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>此时，再打开 GDB 看看调用栈。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb `which python` /var/cores/core.python.30520</span></span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1</span><br><span class="line">[...]</span><br><span class="line">Reading symbols from /usr/bin/python...Reading symbols from /usr/lib/debug/.build-id/4e/a0539215b2a9e32602f81c90240874132c1a54.debug...done.</span><br><span class="line">[...]</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  ClrBlank (win=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1129</span></span><br><span class="line"><span class="comment">#1  ClrUpdate () at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1147</span></span><br><span class="line"><span class="comment">#2  doupdate () at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1010</span></span><br><span class="line"><span class="comment">#3  0x00007f0a37aa07e6 in wrefresh (win=win@entry=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_refresh.c:65</span></span><br><span class="line"><span class="comment">#4  0x00007f0a37a99499 in recur_wrefresh (win=win@entry=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_getch.c:384</span></span><br><span class="line"><span class="comment">#5  0x00007f0a37a99616 in _nc_wgetch (win=win@entry=0x1993060, result=result@entry=0x7ffd33d93e24, use_meta=1)</span></span><br><span class="line">    at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_getch.c:491</span><br><span class="line"><span class="comment">#6  0x00007f0a37a9a325 in wgetch (win=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_getch.c:672</span></span><br><span class="line"><span class="comment">#7  0x00007f0a37cc6ec3 in PyCursesWindow_GetCh.lto_priv.109 (self=0x7f0a3c57b198, args=()) at /build/python2.7-HpIZBG/python2.7-2.7.11/Modules/_cursesmodule.c:853</span></span><br><span class="line"><span class="comment">#8  0x00000000004c4d5a in call_function (oparg=&lt;optimized out&gt;, pp_stack=0x7ffd33d93f30) at ../Python/ceval.c:4350</span></span><br><span class="line"><span class="comment">#9  PyEval_EvalFrameEx () at ../Python/ceval.c:2987</span></span><br><span class="line"><span class="comment">#10 0x00000000004c2e05 in PyEval_EvalCodeEx () at ../Python/ceval.c:3582</span></span><br><span class="line"><span class="comment">#11 0x00000000004def08 in function_call.lto_priv () at ../Objects/funcobject.c:523</span></span><br><span class="line"><span class="comment">#12 0x00000000004b1153 in PyObject_Call () at ../Objects/abstract.c:2546</span></span><br><span class="line"><span class="comment">#13 0x00000000004c73ec in ext_do_call (nk=0, na=&lt;optimized out&gt;, flags=&lt;optimized out&gt;, pp_stack=0x7ffd33d941e8, func=&lt;function at remote 0x7f0a37edcc80&gt;)</span></span><br><span class="line">    at ../Python/ceval.c:4662</span><br><span class="line"><span class="comment">#14 PyEval_EvalFrameEx () at ../Python/ceval.c:3026</span></span><br><span class="line"><span class="comment">#15 0x00000000004c2e05 in PyEval_EvalCodeEx () at ../Python/ceval.c:3582</span></span><br><span class="line"><span class="comment">#16 0x00000000004caf42 in fast_function (nk=0, na=&lt;optimized out&gt;, n=&lt;optimized out&gt;, pp_stack=0x7ffd33d943f0, func=&lt;function at remote 0x7f0a38039140&gt;)</span></span><br><span class="line">    at ../Python/ceval.c:4445</span><br><span class="line"><span class="comment">#17 call_function (oparg=&lt;optimized out&gt;, pp_stack=0x7ffd33d943f0) at ../Python/ceval.c:4370</span></span><br><span class="line"><span class="comment">#18 PyEval_EvalFrameEx () at ../Python/ceval.c:2987</span></span><br><span class="line"><span class="comment">#19 0x00000000004c2e05 in PyEval_EvalCodeEx () at ../Python/ceval.c:3582</span></span><br><span class="line"><span class="comment">#20 0x00000000004c2ba9 in PyEval_EvalCode (co=&lt;optimized out&gt;, globals=&lt;optimized out&gt;, locals=&lt;optimized out&gt;) at ../Python/ceval.c:669</span></span><br><span class="line"><span class="comment">#21 0x00000000004f20ef in run_mod.lto_priv () at ../Python/pythonrun.c:1376</span></span><br><span class="line"><span class="comment">#22 0x00000000004eca72 in PyRun_FileExFlags () at ../Python/pythonrun.c:1362</span></span><br><span class="line"><span class="comment">#23 0x00000000004eb1f1 in PyRun_SimpleFileExFlags () at ../Python/pythonrun.c:948</span></span><br><span class="line"><span class="comment">#24 0x000000000049e18a in Py_Main () at ../Modules/main.c:640</span></span><br><span class="line"><span class="comment">#25 0x00007f0a3be10830 in __libc_start_main (main=0x49daf0 &lt;main&gt;, argc=2, argv=0x7ffd33d94838, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;,</span></span><br><span class="line">    stack_end=0x7ffd33d94828) at ../csu/libc-start.c:291</span><br><span class="line"><span class="comment">#26 0x000000000049da19 in _start ()</span></span><br></pre></td></tr></table></figure>

<p>此时，所有的 <code>??</code> 都不见了，然而对解决我们的问题并没有什么 X 用……</p>
<p>此外，Python 调试软件包还加强了 GDB 的功能。我们现在可以看看 Python 的调用栈。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) py-bt</span><br><span class="line">Traceback (most recent call first):</span><br><span class="line">  File <span class="string">"./cachetop.py"</span>, line 188, <span class="keyword">in</span> handle_loop</span><br><span class="line">    s = stdscr.getch()</span><br><span class="line">  File <span class="string">"/usr/lib/python2.7/curses/wrapper.py"</span>, line 43, <span class="keyword">in</span> wrapper</span><br><span class="line">    <span class="built_in">return</span> func(stdscr, *args, **kwds)</span><br><span class="line">  File <span class="string">"./cachetop.py"</span>, line 260, <span class="keyword">in</span></span><br><span class="line">    curses.wrapper(handle_loop, args)</span><br></pre></td></tr></table></figure>

<p>以及，我们可以看看 Python 代码是怎样的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(gdb) py-list</span><br><span class="line"> 183        b.attach_kprobe(event=<span class="string">"mark_buffer_dirty"</span>, fn_name=<span class="string">"do_count"</span>)</span><br><span class="line"> 184</span><br><span class="line"> 185        exiting = 0</span><br><span class="line"> 186</span><br><span class="line"> 187        <span class="keyword">while</span> 1:</span><br><span class="line">&gt;188            s = stdscr.getch()</span><br><span class="line"> 189            <span class="keyword">if</span> s == ord(<span class="string">'q'</span>):</span><br><span class="line"> 190                exiting = 1</span><br><span class="line"> 191            <span class="keyword">elif</span> s == ord(<span class="string">'r'</span>):</span><br><span class="line"> 192                sort_reverse = not sort_reverse</span><br><span class="line"> 193            <span class="keyword">elif</span> s == ord(<span class="string">'&lt;'</span>):</span><br></pre></td></tr></table></figure>

<p>这能指出，在我们的 Python 代码中，究竟是那一行触发了段错误。这看起来非常棒！</p>
<p>之前我们在回溯调用栈时遇到的问题，其原因在于我们看到了 Python 内部在执行的方法（methods），但却看不到对应方法的符号。如果你在调试别的语言，类似的问题取决于它的编译选项和运行环境，以及执行代码是如何结束的。如果你在网上检索「语言名 GDB」，你可能会找到类似 <code>python-dbg</code> 这样的扩展。如果没有的话，坏消息是你必须自己写这样的软件包，但好消息是这样做是可行的。如果你是在调试 Python，那么请在网上检索「add new GDB commands in Pyhon」。</p>
<h2 id="廿四-·-更多……"><a href="#廿四-·-更多……" class="headerlink" title="廿四 · 更多……"></a>廿四 · 更多……</h2><p>看起来，我似乎是要写一个完整的 GDB 指南，但显然我不是：GDB 还有很多我没讲到的东西。你可以在 GDB 中使用 <code>help</code> 命令，分门别类查看 GDB 的其他功能。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">help</span></span><br><span class="line">List of classes of commands:</span><br><span class="line"></span><br><span class="line">aliases -- Aliases of other commands</span><br><span class="line">breakpoints -- Making program stop at certain points</span><br><span class="line">data -- Examining data</span><br><span class="line">files -- Specifying and examining files</span><br><span class="line">internals -- Maintenance commands</span><br><span class="line">obscure -- Obscure features</span><br><span class="line">running -- Running the program</span><br><span class="line">stack -- Examining the stack</span><br><span class="line">status -- Status inquiries</span><br><span class="line">support -- Support facilities</span><br><span class="line">tracepoints -- Tracing of program execution without stopping the program</span><br><span class="line">user-defined -- User-defined commands</span><br><span class="line"></span><br><span class="line">Type <span class="string">"help"</span> followed by a class name <span class="keyword">for</span> a list of commands <span class="keyword">in</span> that class.</span><br><span class="line">Type <span class="string">"help all"</span> <span class="keyword">for</span> the list of all commands.</span><br><span class="line">Type <span class="string">"help"</span> followed by <span class="built_in">command</span> name <span class="keyword">for</span> full documentation.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>.</span><br><span class="line">Command name abbreviations are allowed <span class="keyword">if</span> unambiguous.</span><br></pre></td></tr></table></figure>

<p>对于具体某个命令来说，你也可以用 <code>help</code> 命令查看具体用法。例如说，你可以查看所有和 <code>breakpoints</code> 相关的命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">help</span> breakpoints</span><br><span class="line">Making program stop at certain points.</span><br><span class="line"></span><br><span class="line">List of commands:</span><br><span class="line"></span><br><span class="line">awatch -- Set a watchpoint <span class="keyword">for</span> an expression</span><br><span class="line"><span class="built_in">break</span> -- Set breakpoint at specified location</span><br><span class="line"><span class="built_in">break</span>-range -- Set a breakpoint <span class="keyword">for</span> an address range</span><br><span class="line">catch -- Set catchpoints to catch events</span><br><span class="line">catch assert -- Catch failed Ada assertions</span><br><span class="line">catch catch -- Catch an exception</span><br><span class="line">catch exception -- Catch Ada exceptions</span><br><span class="line">catch <span class="built_in">exec</span> -- Catch calls to <span class="built_in">exec</span></span><br><span class="line">catch fork -- Catch calls to fork</span><br><span class="line">catch load -- Catch loads of shared libraries</span><br><span class="line">catch rethrow -- Catch an exception</span><br><span class="line">catch signal -- Catch signals by their names and/or numbers</span><br><span class="line">catch syscall -- Catch system calls by their names and/or numbers</span><br><span class="line">catch throw -- Catch an exception</span><br><span class="line">catch unload -- Catch unloads of shared libraries</span><br><span class="line">catch vfork -- Catch calls to vfork</span><br><span class="line">clear -- Clear breakpoint at specified location</span><br><span class="line">commands -- Set commands to be executed when a breakpoint is hit</span><br><span class="line">condition -- Specify breakpoint number N to <span class="built_in">break</span> only <span class="keyword">if</span> COND is <span class="literal">true</span></span><br><span class="line">delete -- Delete some breakpoints or auto-display expressions</span><br><span class="line">delete bookmark -- Delete a bookmark from the bookmark list</span><br><span class="line">delete breakpoints -- Delete some breakpoints or auto-display expressions</span><br><span class="line">delete checkpoint -- Delete a checkpoint (experimental)</span><br><span class="line">delete display -- Cancel some expressions to be displayed when program stops</span><br><span class="line">delete mem -- Delete memory region</span><br><span class="line">delete tracepoints -- Delete specified tracepoints</span><br><span class="line">delete tvariable -- Delete one or more trace state variables</span><br><span class="line"><span class="built_in">disable</span> -- Disable some breakpoints</span><br><span class="line"><span class="built_in">disable</span> breakpoints -- Disable some breakpoints</span><br><span class="line"><span class="built_in">disable</span> display -- Disable some expressions to be displayed when program stops</span><br><span class="line"><span class="built_in">disable</span> frame-filter -- GDB <span class="built_in">command</span> to <span class="built_in">disable</span> the specified frame-filter</span><br><span class="line"><span class="built_in">disable</span> mem -- Disable memory region</span><br><span class="line"><span class="built_in">disable</span> pretty-printer -- GDB <span class="built_in">command</span> to <span class="built_in">disable</span> the specified pretty-printer</span><br><span class="line"><span class="built_in">disable</span> probes -- Disable probes</span><br><span class="line"><span class="built_in">disable</span> tracepoints -- Disable specified tracepoints</span><br><span class="line"><span class="built_in">disable</span> <span class="built_in">type</span>-printer -- GDB <span class="built_in">command</span> to <span class="built_in">disable</span> the specified <span class="built_in">type</span>-printer</span><br><span class="line"><span class="built_in">disable</span> unwinder -- GDB <span class="built_in">command</span> to <span class="built_in">disable</span> the specified unwinder</span><br><span class="line"><span class="built_in">disable</span> xmethod -- GDB <span class="built_in">command</span> to <span class="built_in">disable</span> a specified (group of) xmethod(s)</span><br><span class="line">dprintf -- Set a dynamic <span class="built_in">printf</span> at specified location</span><br><span class="line"><span class="built_in">enable</span> -- Enable some breakpoints</span><br><span class="line"><span class="built_in">enable</span> breakpoints -- Enable some breakpoints</span><br><span class="line"><span class="built_in">enable</span> breakpoints count -- Enable breakpoints <span class="keyword">for</span> COUNT hits</span><br><span class="line"><span class="built_in">enable</span> breakpoints delete -- Enable breakpoints and delete when hit</span><br><span class="line"><span class="built_in">enable</span> breakpoints once -- Enable breakpoints <span class="keyword">for</span> one hit</span><br><span class="line"><span class="built_in">enable</span> count -- Enable breakpoints <span class="keyword">for</span> COUNT hits</span><br><span class="line"><span class="built_in">enable</span> delete -- Enable breakpoints and delete when hit</span><br><span class="line"><span class="built_in">enable</span> display -- Enable some expressions to be displayed when program stops</span><br><span class="line"><span class="built_in">enable</span> frame-filter -- GDB <span class="built_in">command</span> to <span class="built_in">disable</span> the specified frame-filter</span><br><span class="line"><span class="built_in">enable</span> mem -- Enable memory region</span><br><span class="line"><span class="built_in">enable</span> once -- Enable breakpoints <span class="keyword">for</span> one hit</span><br><span class="line"><span class="built_in">enable</span> pretty-printer -- GDB <span class="built_in">command</span> to <span class="built_in">enable</span> the specified pretty-printer</span><br><span class="line"><span class="built_in">enable</span> probes -- Enable probes</span><br><span class="line"><span class="built_in">enable</span> tracepoints -- Enable specified tracepoints</span><br><span class="line"><span class="built_in">enable</span> <span class="built_in">type</span>-printer -- GDB <span class="built_in">command</span> to <span class="built_in">enable</span> the specified <span class="built_in">type</span> printer</span><br><span class="line"><span class="built_in">enable</span> unwinder -- GDB <span class="built_in">command</span> to <span class="built_in">enable</span> unwinders</span><br><span class="line"><span class="built_in">enable</span> xmethod -- GDB <span class="built_in">command</span> to <span class="built_in">enable</span> a specified (group of) xmethod(s)</span><br><span class="line">ftrace -- Set a fast tracepoint at specified location</span><br><span class="line">hbreak -- Set a hardware assisted breakpoint</span><br><span class="line">ignore -- Set ignore-count of breakpoint number N to COUNT</span><br><span class="line">rbreak -- Set a breakpoint <span class="keyword">for</span> all <span class="built_in">functions</span> matching REGEXP</span><br><span class="line">rwatch -- Set a <span class="built_in">read</span> watchpoint <span class="keyword">for</span> an expression</span><br><span class="line">save -- Save breakpoint definitions as a script</span><br><span class="line">save breakpoints -- Save current breakpoint definitions as a script</span><br><span class="line">save gdb-index -- Save a gdb-index file</span><br><span class="line">save tracepoints -- Save current tracepoint definitions as a script</span><br><span class="line">skip -- Ignore a <span class="keyword">function</span> <span class="keyword">while</span> stepping</span><br><span class="line">skip delete -- Delete skip entries</span><br><span class="line">skip <span class="built_in">disable</span> -- Disable skip entries</span><br><span class="line">skip <span class="built_in">enable</span> -- Enable skip entries</span><br><span class="line">skip file -- Ignore a file <span class="keyword">while</span> stepping</span><br><span class="line">skip <span class="keyword">function</span> -- Ignore a <span class="keyword">function</span> <span class="keyword">while</span> stepping</span><br><span class="line">strace -- Set a static tracepoint at location or marker</span><br><span class="line">tbreak -- Set a temporary breakpoint</span><br><span class="line">tcatch -- Set temporary catchpoints to catch events</span><br><span class="line">tcatch assert -- Catch failed Ada assertions</span><br><span class="line">tcatch catch -- Catch an exception</span><br><span class="line">tcatch exception -- Catch Ada exceptions</span><br><span class="line">tcatch <span class="built_in">exec</span> -- Catch calls to <span class="built_in">exec</span></span><br><span class="line">tcatch fork -- Catch calls to fork</span><br><span class="line">tcatch load -- Catch loads of shared libraries</span><br><span class="line">tcatch rethrow -- Catch an exception</span><br><span class="line">tcatch signal -- Catch signals by their names and/or numbers</span><br><span class="line">tcatch syscall -- Catch system calls by their names and/or numbers</span><br><span class="line">tcatch throw -- Catch an exception</span><br><span class="line">tcatch unload -- Catch unloads of shared libraries</span><br><span class="line">tcatch vfork -- Catch calls to vfork</span><br><span class="line">thbreak -- Set a temporary hardware assisted breakpoint</span><br><span class="line">trace -- Set a tracepoint at specified location</span><br><span class="line">watch -- Set a watchpoint <span class="keyword">for</span> an expression</span><br><span class="line"></span><br><span class="line">Type <span class="string">"help"</span> followed by <span class="built_in">command</span> name <span class="keyword">for</span> full documentation.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>.</span><br><span class="line">Command name abbreviations are allowed <span class="keyword">if</span> unambiguous.</span><br></pre></td></tr></table></figure>

<p>显而易见，GDB 还有很多功能，而我仅只是在解决问题的过程中使用了其中很小一部分。</p>
<h2 id="廿五-·-结语"><a href="#廿五-·-结语" class="headerlink" title="廿五 · 结语"></a>廿五 · 结语</h2><p>好吧，这里我遇到的问题比较恶心：这是一个由 LLVM 的 bug 经由 ncurses 最终导致 Python 程序崩溃的例子。不过，解决问题过程中，我用到的命令和使用他们的流程基本就是调试查错的基本流程：查看调用栈、检查寄存器、设置断点、单步调试、浏览代码。</p>
<p>当我在几年前第一次使用 GDB 时，我真的不怎么喜欢它。它看起来又笨拙又难用。然而，GDB 已经改进了很多，同时也有了一些 GDB 调试查错的技巧之后，现在我认为它是一个强大的现代调试器。不同调试器有不同的技能，但是 GDB 必是其中最强大的文本调试器——当然 <code>lldb</code> 正在迎头赶上。</p>
<p>在此，我希望所有查找 GDB 调试范例的人会从我的例子和警示中学到东西。当然，以后有机会我也会分享更多关于 GDB 的经验——尤其是诸如 JAVA 的运行时问题。</p>
<p>哦对了，退出 GDB 的方法是 <code>q</code> (<code>quit</code>) 命令。（译者注：你也可以使用 <code>Ctrl + D</code> 来退出 GDB 调试器。）</p>

    </div>

    
    
    <div class="post-widgets">
      <div id="needsharebutton-postbottom">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    </div>
        <div class="reward-container">
  <div>俗话说，投资效率是最好的投资。 如果您感觉我的文章质量不错，读后收获很大，预计能为您提高 10% 的工作效率，不妨小额捐助我一下，让我有动力继续写出更多好文章。</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/reward/wechatpay-cropped.png" alt="Liam Huang 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/reward/alipay-cropped.png" alt="Liam Huang 支付宝">
        <p>支付宝</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/reward/paypal.jpeg" alt="Liam Huang 贝宝">
        <p>贝宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Liam Huang
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://liam.page/2017/05/27/tutorial-to-GDB-taking-ncurses-as-an-example/" title="GDB 入门教程：调试 ncurses 相关 bug 的完整范例">https://liam.page/2017/05/27/tutorial-to-GDB-taking-ncurses-as-an-example/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/GDB/" rel="tag"># GDB</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2017/05/25/the-mutable-keyword-in-Cxx/" rel="prev" title="C++ 中的 mutable 关键字">
      <i class="fa fa-chevron-left"></i> C++ 中的 mutable 关键字
    </a></div>
      <div class="post-nav-item">
    <a href="/2017/06/10/protecting-data-sharing-between-threads/" rel="next" title="程序员的自我修养（六）：保护线程间的共享数据">
      程序员的自我修养（六）：保护线程间的共享数据 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一-·-问题来了"><span class="nav-number">1.</span> <span class="nav-text">一 · 问题来了</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二-·-获得核心转储文件"><span class="nav-number">2.</span> <span class="nav-text">二 · 获得核心转储文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三-·-启动-GDB"><span class="nav-number">3.</span> <span class="nav-text">三 · 启动 GDB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四-·-逆向追溯"><span class="nav-number">4.</span> <span class="nav-text">四 · 逆向追溯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五-·-反汇编"><span class="nav-number">5.</span> <span class="nav-text">五 · 反汇编</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六-·-查看寄存器状态"><span class="nav-number">6.</span> <span class="nav-text">六 · 查看寄存器状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#七-·-内存映射"><span class="nav-number">7.</span> <span class="nav-text">七 · 内存映射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#八-·-断点"><span class="nav-number">8.</span> <span class="nav-text">八 · 断点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#⑨-·-单步调试"><span class="nav-number">9.</span> <span class="nav-text">⑨ · 单步调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十-·-单步回退"><span class="nav-number">10.</span> <span class="nav-text">十 · 单步回退</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十一-·-调试信息"><span class="nav-number">11.</span> <span class="nav-text">十一 · 调试信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十二-·-源代码"><span class="nav-number">12.</span> <span class="nav-text">十二 · 源代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十三-·-TUI"><span class="nav-number">13.</span> <span class="nav-text">十三 · TUI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十四-·-外部工具：cscope"><span class="nav-number">14.</span> <span class="nav-text">十四 · 外部工具：cscope</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十五-·-外部工具：perf-tools-ftrace-uprobes"><span class="nav-number">15.</span> <span class="nav-text">十五 · 外部工具：perf-tools/ftrace/uprobes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十六-·-外部工具：bcc-BPF"><span class="nav-number">16.</span> <span class="nav-text">十六 · 外部工具：bcc/BPF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十七-·-更多的断点"><span class="nav-number">17.</span> <span class="nav-text">十七 · 更多的断点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十八-·-外部工具：再次使用-cscope"><span class="nav-number">18.</span> <span class="nav-text">十八 · 外部工具：再次使用 cscope</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#十九-·-复写内存"><span class="nav-number">19.</span> <span class="nav-text">十九 · 复写内存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二十-·-条件断点"><span class="nav-number">20.</span> <span class="nav-text">二十 · 条件断点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#廿一-·-直接返回"><span class="nav-number">21.</span> <span class="nav-text">廿一 · 直接返回</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#廿二-·-更好的方案"><span class="nav-number">22.</span> <span class="nav-text">廿二 · 更好的方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#廿三-·-关于-Python-的环境"><span class="nav-number">23.</span> <span class="nav-text">廿三 · 关于 Python 的环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#廿四-·-更多……"><span class="nav-number">24.</span> <span class="nav-text">廿四 · 更多……</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#廿五-·-结语"><span class="nav-number">25.</span> <span class="nav-text">廿五 · 结语</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Liam Huang"
      src="/images/avatar/avatar.webp">
  <p class="site-author-name" itemprop="name">Liam Huang</p>
  <div class="site-description" itemprop="description">虚室生白，吉祥止止</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">346</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">669</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → /atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      友情链接
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://anyi.im/" title="https://anyi.im/" rel="noopener" target="_blank">Anyi</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://chattymoney.com/" title="http://chattymoney.com/" rel="noopener" target="_blank">ChattyMoney</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://qixinbo.info/" title="http://qixinbo.info/" rel="noopener" target="_blank">XinboQi</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.fuzihao.org" title="http://www.fuzihao.org" rel="noopener" target="_blank">FuZihao</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ionizing.page/" title="https://ionizing.page/" rel="noopener" target="_blank">ChenLinjie</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://yihui.name/" title="https://yihui.name/" rel="noopener" target="_blank">Yihui</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.felixc.at/" title="https://blog.felixc.at/" rel="noopener" target="_blank">Felix</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://wyydsb.xin/" title="https://wyydsb.xin/" rel="noopener" target="_blank">Gunjianpan</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://joselynzhao.top/" title="https://joselynzhao.top/" rel="noopener" target="_blank">JoselynZhao</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.dang.fan/" title="https://blog.dang.fan/" rel="noopener" target="_blank">DangFan</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://harrychen.xyz" title="https://harrychen.xyz" rel="noopener" target="_blank">HarryChen</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.echen.me/" title="https://blog.echen.me/" rel="noopener" target="_blank">EdwinChen</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://lltuo.com/" title="https://lltuo.com/" rel="noopener" target="_blank">Shadow</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://fengweiustc.github.io/" title="https://fengweiustc.github.io/" rel="noopener" target="_blank">WayneFung</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.cyningsun.com/" title="https://www.cyningsun.com/" rel="noopener" target="_blank">CyningSun</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2013 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liam Huang</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">1.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">39:09</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>


<script>
  window.addEventListener('DOMContentLoaded', function() {
    
    
    var intervalTotalViews = setInterval(fixTotalViews, 100);
    var offsetTotalViews   = parseInt(100000);
    function fixTotalViews() {
      if (document.getElementById('busuanzi_container_site_pv').style.display != "none") {
        clearInterval(intervalTotalViews);
        var el = document.getElementById("busuanzi_value_site_pv");
        var value = parseInt(el.innerHTML) + offsetTotalViews;
        el.innerHTML = '' + value;
      }
    }
    
  });
</script>










      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  <script src="/js/local-search.js"></script>













<script type="text/javascript">
var crashSwitched = false;
var originalTitle = document.title;
var titleTime;
document.addEventListener('visibilitychange', function () {
  if (document.hidden) {
    if (Math.random() < parseFloat(0.25)) {
      crashSwitched = true;
      document.title = '╭(°A°`)╮ 页面崩溃啦~' + originalTitle;
      clearTimeout(titleTime);
    }
  } else {
    if (crashSwitched == true) {
      crashSwitched = false;
      document.title = '(ฅ>ω<*ฅ) 咦，又好了~' + originalTitle;
      titleTime = setTimeout(function () {
        document.title = originalTitle;
      }, 2000);
    }
  }
});
</script>



    <div id="pjax">
  

  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://liam.page/2017/05/27/tutorial-to-GDB-taking-ncurses-as-an-example/',]
      });
      });
  </script>

  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.js"></script>
  <script>
      pbOptions = {};
        pbOptions.iconStyle = "default";
        pbOptions.boxForm = "horizontal";
        pbOptions.position = "topCenter";
        pbOptions.networks = "Wechat,Weibo,renren,Twitter,Facebook,Douban,QQZone,Evernote,Mailto";
      new needShareButton('#needsharebutton-postbottom', pbOptions);
  </script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'a3d846b3392f468b5746',
      clientSecret: '61bc947cad0ec7078e800e05b1e3c78b763b2c55',
      repo        : 'liam0205.github.io',
      owner       : 'Liam0205',
      admin       : ['Liam0205'],
      id          : '0b0c945518d434d16ee49222b5261cc3',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

    </div>
</body>
</html>
